<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
      
        <meta name="robots" content="noindex,follow">
      
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>zz胖的博客</title>
  
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
          
            ZZ胖的博客 <b><sup style='color:#3AA757'></sup></b>
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  
  <section class="post-list ">
    
    
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2018/06/23/docker/install-docker/">
      [Docker] 安装Docker
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jun 23, 2018</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-CentOS-安装Docker"><a href="#1-CentOS-安装Docker" class="headerlink" title="1. CentOS 安装Docker"></a>1. CentOS 安装Docker</h2><blockquote>
<p>建议使用centos7</p>
</blockquote>
<h3 id="1-1-安装Docker"><a href="#1-1-安装Docker" class="headerlink" title="1.1. 安装Docker"></a>1.1. 安装Docker</h3><h4 id="1-1-1-卸载旧版本"><a href="#1-1-1-卸载旧版本" class="headerlink" title="1.1.1. 卸载旧版本"></a>1.1.1. 卸载旧版本</h4><p>旧版本的Docker命名为<code>docker</code>或<code>docker-engine</code>，如果有安装旧版本，先卸载旧版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum remove -y docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>

<h4 id="1-1-2-使用仓库安装"><a href="#1-1-2-使用仓库安装" class="headerlink" title="1.1.2. 使用仓库安装"></a>1.1.2. 使用仓库安装</h4><p>1、安装yum-utils、device-mapper-persistent-data、lvm2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure>

<p>2、添加软件源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h4 id="1-1-3-安装Docker"><a href="#1-1-3-安装Docker" class="headerlink" title="1.1.3. 安装Docker"></a>1.1.3. 安装Docker</h4><p>安装最新版本的Docker CE。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install -y docker-ce</span><br></pre></td></tr></table></figure>

<h4 id="1-1-4-启动Docker"><a href="#1-1-4-启动Docker" class="headerlink" title="1.1.4. 启动Docker"></a>1.1.4. 启动Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Docker</span></span><br><span class="line">$ sudo systemctl start docker</span><br><span class="line"><span class="comment"># 运行容器</span></span><br><span class="line">$ sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<h3 id="1-2-安装指定版本Docker"><a href="#1-2-安装指定版本Docker" class="headerlink" title="1.2. 安装指定版本Docker"></a>1.2. 安装指定版本Docker</h3><p>1、列出可安装版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum list docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line">docker-ce.x86_64            18.03.0.ce-1.el7.centos             docker-ce-stable</span><br></pre></td></tr></table></figure>

<p>2、安装指定版本</p>
<p>例如：docker-ce-18.03.0.ce</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install docker-ce-&lt;VERSION STRING&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-升级Docker"><a href="#1-3-升级Docker" class="headerlink" title="1.3. 升级Docker"></a>1.3. 升级Docker</h3><p>依据1.2的方法选择指定版本安装。</p>
<h3 id="1-4-卸载Docker"><a href="#1-4-卸载Docker" class="headerlink" title="1.4. 卸载Docker"></a>1.4. 卸载Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载Docker</span></span><br><span class="line">$ sudo yum remove docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理镜像、容器、存储卷等</span></span><br><span class="line">$ sudo rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>

<h2 id="2-Ubuntu-安装Docker"><a href="#2-Ubuntu-安装Docker" class="headerlink" title="2. Ubuntu 安装Docker"></a>2. Ubuntu 安装Docker</h2><h3 id="2-1-安装Docker"><a href="#2-1-安装Docker" class="headerlink" title="2.1. 安装Docker"></a>2.1. 安装Docker</h3><h4 id="2-1-1-卸载旧版本"><a href="#2-1-1-卸载旧版本" class="headerlink" title="2.1.1. 卸载旧版本"></a>2.1.1. 卸载旧版本</h4><p>旧版本的Docker命名为<code>docker</code>或<code>docker-engine</code>，如果有安装旧版本，先卸载旧版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-使用仓库安装"><a href="#2-1-2-使用仓库安装" class="headerlink" title="2.1.2. 使用仓库安装"></a>2.1.2. 使用仓库安装</h4><p>1、升级apt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<p>2、允许apt使用https</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    software-properties-common</span><br></pre></td></tr></table></figure>

<p>3、添加Docker 官方的GPG密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>

<p>4、添加Docker软件源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository \</span><br><span class="line">   <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable"</span></span><br></pre></td></tr></table></figure>

<h4 id="2-1-3-安装Docker"><a href="#2-1-3-安装Docker" class="headerlink" title="2.1.3. 安装Docker"></a>2.1.3. 安装Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># update</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># install docker</span></span><br><span class="line">sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure>

<h4 id="2-1-4-启动Docker"><a href="#2-1-4-启动Docker" class="headerlink" title="2.1.4. 启动Docker"></a>2.1.4. 启动Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置为开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>

<h3 id="2-2-安装指定版本Docker"><a href="#2-2-安装指定版本Docker" class="headerlink" title="2.2. 安装指定版本Docker"></a>2.2. 安装指定版本Docker</h3><p>1、列出仓库的可安装版本，<code>apt-cache madison docker-ce</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line"> docker-ce | 18.06.0~ce~3-0~ubuntu | https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line"> docker-ce | 18.03.1~ce~3-0~ubuntu | https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages</span><br></pre></td></tr></table></figure>

<p>2、指定版本安装</p>
<p>例如：docker-ce=18.03.0<del>ce-0</del>ubuntu</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce=&lt;VERSION&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-升级Docker"><a href="#2-3-升级Docker" class="headerlink" title="2.3.  升级Docker"></a>2.3.  升级Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新源</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 依据上述方法，指定版本安装</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-卸载Docker"><a href="#2-4-卸载Docker" class="headerlink" title="2.4. 卸载Docker"></a>2.4. 卸载Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载 docker ce</span></span><br><span class="line">sudo apt-get purge docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理镜像、容器、存储卷等</span></span><br><span class="line">sudo rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>



<p>文章参考：</p>
<p><a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
<p><a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2018/04/17/redis/redis-cluster/">
      [Redis] Redis集群模式部署
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Apr 17, 2018</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-Redis部署"><a href="#1-Redis部署" class="headerlink" title="1. Redis部署"></a>1. Redis部署</h2><blockquote>
<p>以下以Linux系统为例</p>
</blockquote>
<h3 id="1-1-下载和编译"><a href="#1-1-下载和编译" class="headerlink" title="1.1 下载和编译"></a>1.1 下载和编译</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget http://download.redis.io/releases/redis-4.0.7.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar xzf redis-4.0.7.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> redis-4.0.7</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>编译完成后会在<code>src</code>目录下生成Redis服务端程序<code>redis-server</code>和客户端程序<code>redis-cli</code>。</p>
<h3 id="1-2-启动服务"><a href="#1-2-启动服务" class="headerlink" title="1.2 启动服务"></a>1.2 启动服务</h3><p><strong>1、前台运行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redis-server</span><br></pre></td></tr></table></figure>

<p>该方式启动默认为<code>前台方式</code>运行，使用默认配置。</p>
<p><strong>2、后台运行</strong></p>
<p>可以修改<code>redis.conf</code>文件的<code>daemonize</code>参数为<code>yes</code>，指定配置文件启动，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi redis.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis does not run as a daemon. Use <span class="string">'yes'</span> <span class="keyword">if</span> you need it.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that Redis will write a pid file <span class="keyword">in</span> /var/run/redis.pid when daemonized.</span></span><br><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>

<p>指定配置文件启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/redis-server redis.conf</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">指定配置文件后台启动</span></span><br><span class="line">[root@kube-node-1 redis-4.0.7]# src/redis-server redis.conf</span><br><span class="line">95778:C 30 Jan 00:44:37.633 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">95778:C 30 Jan 00:44:37.634 # Redis version=4.0.7, bits=64, commit=00000000, modified=0, pid=95778, just started</span><br><span class="line">95778:C 30 Jan 00:44:37.634 # Configuration loaded</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看Redis进程</span></span><br><span class="line">[root@kube-node-1 redis-4.0.7]# ps aux|grep redis</span><br><span class="line">root      95779  0.0  0.0 145268   468 ?        Ssl  00:44   0:00 src/redis-server 127.0.0.1:6379</span><br></pre></td></tr></table></figure>

<p>更多启动参数如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 src]# ./redis-server --help</span><br><span class="line">Usage: ./redis-server [/path/to/redis.conf] [options]</span><br><span class="line">       ./redis-server - (read config from stdin)</span><br><span class="line">       ./redis-server -v or --version</span><br><span class="line">       ./redis-server -h or --help</span><br><span class="line">       ./redis-server --test-memory &lt;megabytes&gt;</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">       ./redis-server (run the server with default conf)</span><br><span class="line">       ./redis-server /etc/redis/6379.conf</span><br><span class="line">       ./redis-server --port 7777</span><br><span class="line">       ./redis-server --port 7777 --slaveof 127.0.0.1 8888</span><br><span class="line">       ./redis-server /etc/myredis.conf --loglevel verbose</span><br><span class="line"></span><br><span class="line">Sentinel mode:</span><br><span class="line">       ./redis-server /etc/sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<h3 id="1-3-客户端测试"><a href="#1-3-客户端测试" class="headerlink" title="1.3 客户端测试"></a>1.3 客户端测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> src/redis-cli</span></span><br><span class="line"><span class="meta">redis&gt;</span><span class="bash"> <span class="built_in">set</span> foo bar</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta">redis&gt;</span><span class="bash"> get foo</span></span><br><span class="line">"bar"</span><br></pre></td></tr></table></figure>

<h2 id="2-Redis集群部署"><a href="#2-Redis集群部署" class="headerlink" title="2. Redis集群部署"></a>2. Redis集群部署</h2><p>Redis的集群部署需要在每台集群部署的机器上安装Redis（可参考上述的[Redis安装] ），然后修改配置以集群的方式启动。</p>
<h3 id="2-1-手动部署集群"><a href="#2-1-手动部署集群" class="headerlink" title="2.1 手动部署集群"></a>2.1 手动部署集群</h3><h4 id="2-1-1-设置配置文件及启动实例"><a href="#2-1-1-设置配置文件及启动实例" class="headerlink" title="2.1.1 设置配置文件及启动实例"></a>2.1.1 设置配置文件及启动实例</h4><p>修改配置文件redis.conf，集群模式的最小化配置文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">可选操作，该项设置后台方式运行，</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line">port 7000</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多集群配置参数可参考默认配置文件redis.conf中<code>Cluster</code>模块的说明</p>
</blockquote>
<p>最小集群模式需要三个master实例，一般建议起六个实例，即三主三从。因此我们创建6个以端口号命名的目录存放实例的配置文件和其他信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir cluster-test</span><br><span class="line">cd cluster-test</span><br><span class="line">mkdir 7000 7001 7002 7003 7004 7005</span><br></pre></td></tr></table></figure>

<p>在对应端口号的目录中创建<code>redis.conf</code>的文件，配置文件的内容可参考上述的集群模式配置。每个配置文件中的端口号<code>port</code>参数改为对应目录的端口号。</p>
<p>复制<code>redis-server</code>的二进制文件到<code>cluster-test</code>目录中，通过指定配置文件的方式启动<code>redis</code>服务，例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd 7000</span><br><span class="line">../redis-server ./redis.conf</span><br></pre></td></tr></table></figure>

<p>如果是以前台方式运行，则会在控制台输出以下信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[82462] 26 Nov 11:56:55.329 * No cluster configuration found, I'm 97a3a64667477371c4479320d683e4c8db5858b1</span><br></pre></td></tr></table></figure>

<p>每个实例都会生成一个<code>Node ID</code>，类似<code>97a3a64667477371c4479320d683e4c8db5858b1</code>，用来作为Redis实例在集群中的唯一标识，而不是通过IP和Port，IP和Port可能会改变，该<code>Node ID</code>不会改变。</p>
<p>目录结构可参考：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cluster-test/</span><br><span class="line">├── 7000</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── 7001</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── 7002</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── 7003</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── 7004</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── 7005</span><br><span class="line">│   ├── appendonly.aof</span><br><span class="line">│   ├── dump.rdb</span><br><span class="line">│   ├── nodes.conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── redis-cli</span><br><span class="line">└── redis-server</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-redis-trib创建集群"><a href="#2-1-2-redis-trib创建集群" class="headerlink" title="2.1.2 redis-trib创建集群"></a>2.1.2 redis-trib创建集群</h4><p>Redis的实例全部运行之后，还需要<code>redis-trib.rb</code>工具来完成集群的创建，<code>redis-trib.rb</code>二进制文件在Redis包主目录下的<code>src</code>目录中，运行该工具依赖<code>Ruby</code>环境和<code>gem</code>，因此需要提前安装。</p>
<p><strong>1、安装Ruby</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ruby rubygems</span><br></pre></td></tr></table></figure>

<p>查看Ruby版本信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 src]# ruby --version</span><br><span class="line">ruby 2.0.0p648 (2015-12-16) [x86_64-linux]</span><br></pre></td></tr></table></figure>

<p>由于<code>centos</code>系统默认支持Ruby版本为<code>2.0.0</code>，因此执行<code>gem install redis</code>命令时会报以下错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 src]# gem install redis</span><br><span class="line">Fetching: redis-4.0.1.gem (100%)</span><br><span class="line">ERROR:  Error installing redis:</span><br><span class="line">	redis requires Ruby version &gt;= 2.2.2.</span><br></pre></td></tr></table></figure>

<p>解决方法是先安装<code>rvm</code>，再升级<code>ruby</code>版本。</p>
<p><strong>2、安装rvm</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L get.rvm.io | bash -s stable</span><br></pre></td></tr></table></figure>

<p>如果遇到以下报错，则执行报错中的<code>gpg2 --recv-keys</code>的命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# curl -L get.rvm.io | bash -s stable</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   194  100   194    0     0    335      0 --:--:-- --:--:-- --:--:--   335</span><br><span class="line">100 24090  100 24090    0     0  17421      0  0:00:01  0:00:01 --:--:-- 44446</span><br><span class="line">Downloading https://github.com/rvm/rvm/archive/1.29.3.tar.gz</span><br><span class="line">Downloading https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc</span><br><span class="line">gpg: 于 2017年09月11日 星期一 04时59分21秒 CST 创建的签名，使用 RSA，钥匙号 BF04FF17</span><br><span class="line">gpg: 无法检查签名：没有公钥</span><br><span class="line">Warning, RVM 1.26.0 introduces signed releases and automated check of signatures when GPG software found. Assuming you trust Michal Papis import the mpapis public key (downloading the signatures).</span><br><span class="line"></span><br><span class="line">GPG signature verification failed for '/usr/local/rvm/archives/rvm-1.29.3.tgz' - 'https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc'! Try to install GPG v2 and then fetch the public key:</span><br><span class="line"></span><br><span class="line">    gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span><br><span class="line"></span><br><span class="line">or if it fails:</span><br><span class="line"></span><br><span class="line">    command curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -</span><br><span class="line"></span><br><span class="line">the key can be compared with:</span><br><span class="line"></span><br><span class="line">    https://rvm.io/mpapis.asc</span><br><span class="line">    https://keybase.io/mpapis</span><br><span class="line"></span><br><span class="line">NOTE: GPG version 2.1.17 have a bug which cause failures during fetching keys from remote server. Please downgrade or upgrade to newer version (if available) or use the second method described above.</span><br></pre></td></tr></table></figure>

<p>执行报错中的<code>gpg2 --recv-keys</code>的命令。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span><br><span class="line">gpg: 钥匙环‘/root/.gnupg/secring.gpg’已建立</span><br><span class="line">gpg: 下载密钥‘D39DC0E3’，从 hkp 服务器 keys.gnupg.net</span><br><span class="line">gpg: /root/.gnupg/trustdb.gpg：建立了信任度数据库</span><br><span class="line">gpg: 密钥 D39DC0E3：公钥“Michal Papis (RVM signing) &lt;mpapis@gmail.com&gt;”已导入</span><br><span class="line">gpg: 没有找到任何绝对信任的密钥</span><br><span class="line">gpg: 合计被处理的数量：1</span><br><span class="line">gpg:           已导入：1  (RSA: 1)</span><br></pre></td></tr></table></figure>

<p>再次执行命令<code>curl -L get.rvm.io | bash -s stable</code>。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# curl -L get.rvm.io | bash -s stable</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   194  100   194    0     0    310      0 --:--:-- --:--:-- --:--:--   309</span><br><span class="line">100 24090  100 24090    0     0  18230      0  0:00:01  0:00:01 --:--:--  103k</span><br><span class="line">Downloading https://github.com/rvm/rvm/archive/1.29.3.tar.gz</span><br><span class="line">Downloading https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc</span><br><span class="line">gpg: 于 2017年09月11日 星期一 04时59分21秒 CST 创建的签名，使用 RSA，钥匙号 BF04FF17</span><br><span class="line">gpg: 完好的签名，来自于“Michal Papis (RVM signing) &lt;mpapis@gmail.com&gt;”</span><br><span class="line">gpg:               亦即“Michal Papis &lt;michal.papis@toptal.com&gt;”</span><br><span class="line">gpg:               亦即“[jpeg image of size 5015]”</span><br><span class="line">gpg: 警告：这把密钥未经受信任的签名认证！</span><br><span class="line">gpg:       没有证据表明这个签名属于它所声称的持有者。</span><br><span class="line">主钥指纹： 409B 6B17 96C2 7546 2A17  0311 3804 BB82 D39D C0E3</span><br><span class="line">子钥指纹： 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17</span><br><span class="line">GPG verified '/usr/local/rvm/archives/rvm-1.29.3.tgz'</span><br><span class="line">Creating group 'rvm'</span><br><span class="line"></span><br><span class="line">Installing RVM to /usr/local/rvm/</span><br><span class="line">Installation of RVM in /usr/local/rvm/ is almost complete:</span><br><span class="line"></span><br><span class="line">  * First you need to add all users that will be using rvm to 'rvm' group,</span><br><span class="line">    and logout - login again, anyone using rvm will be operating with `umask u=rwx,g=rwx,o=rx`.</span><br><span class="line"></span><br><span class="line">  * To start using RVM you need to run `source /etc/profile.d/rvm.sh`</span><br><span class="line">    in all your open shell windows, in rare cases you need to reopen all shell windows.</span><br></pre></td></tr></table></figure>

<p>以上表示执行成功，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /usr/local/rvm/scripts/rvm</span><br></pre></td></tr></table></figure>

<p>查看rvm库中已知的ruby版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# rvm list known</span><br><span class="line"><span class="meta">#</span><span class="bash"> MRI Rubies</span></span><br><span class="line">[ruby-]1.8.6[-p420]</span><br><span class="line">[ruby-]1.8.7[-head] # security released on head</span><br><span class="line">[ruby-]1.9.1[-p431]</span><br><span class="line">[ruby-]1.9.2[-p330]</span><br><span class="line">[ruby-]1.9.3[-p551]</span><br><span class="line">[ruby-]2.0.0[-p648]</span><br><span class="line">[ruby-]2.1[.10]</span><br><span class="line">[ruby-]2.2[.7]</span><br><span class="line">[ruby-]2.3[.4]</span><br><span class="line">[ruby-]2.4[.1]</span><br><span class="line">ruby-head</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>3、升级Ruby</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装ruby</span></span><br><span class="line">rvm install  2.4.0</span><br><span class="line"><span class="meta">#</span><span class="bash">使用新版本</span></span><br><span class="line">rvm use  2.4.0</span><br><span class="line"><span class="meta">#</span><span class="bash">移除旧版本</span></span><br><span class="line">rvm remove 2.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前版本</span></span><br><span class="line">ruby --version</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# rvm install  2.4.0</span><br><span class="line">Searching for binary rubies, this might take some time.</span><br><span class="line">Found remote file https://rvm_io.global.ssl.fastly.net/binaries/centos/7/x86_64/ruby-2.4.0.tar.bz2</span><br><span class="line">Checking requirements for centos.</span><br><span class="line">Installing requirements for centos.</span><br><span class="line">Installing required packages: autoconf, automake, bison, bzip2, gcc-c++, libffi-devel, libtool, readline-devel, sqlite-devel, zlib-devel, libyaml-devel, openssl-devel................................</span><br><span class="line">Requirements installation successful.</span><br><span class="line">ruby-2.4.0 - #configure</span><br><span class="line">ruby-2.4.0 - #download</span><br><span class="line"><span class="meta">  %</span><span class="bash"> Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 14.0M  100 14.0M    0     0   852k      0  0:00:16  0:00:16 --:--:--  980k</span><br><span class="line">No checksum for downloaded archive, recording checksum in user configuration.</span><br><span class="line">ruby-2.4.0 - #validate archive</span><br><span class="line">ruby-2.4.0 - #extract</span><br><span class="line">ruby-2.4.0 - #validate binary</span><br><span class="line">ruby-2.4.0 - #setup</span><br><span class="line">ruby-2.4.0 - #gemset created /usr/local/rvm/gems/ruby-2.4.0@global</span><br><span class="line">ruby-2.4.0 - #importing gemset /usr/local/rvm/gemsets/global.gems..............................</span><br><span class="line">ruby-2.4.0 - #generating global wrappers........</span><br><span class="line">ruby-2.4.0 - #gemset created /usr/local/rvm/gems/ruby-2.4.0</span><br><span class="line">ruby-2.4.0 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list</span><br><span class="line">ruby-2.4.0 - #generating default wrappers........</span><br><span class="line"></span><br><span class="line">[root@kube-node-1 ~]# rvm use  2.4.0</span><br><span class="line">Using /usr/local/rvm/gems/ruby-2.4.0</span><br><span class="line"></span><br><span class="line">[root@kube-node-1 ~]# rvm remove 2.0.0</span><br><span class="line">ruby-2.0.0-p648 - #already gone</span><br><span class="line">Using /usr/local/rvm/gems/ruby-2.4.0</span><br><span class="line"></span><br><span class="line">[root@kube-node-1 ~]# ruby --version</span><br><span class="line">ruby 2.4.0p0 (2016-12-24 revision 57164) [x86_64-linux]</span><br></pre></td></tr></table></figure>

<p><strong>4、安装gem</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 ~]# gem install redis</span><br><span class="line"></span><br><span class="line">Fetching: redis-4.0.1.gem (100%)</span><br><span class="line">Successfully installed redis-4.0.1</span><br><span class="line">Parsing documentation for redis-4.0.1</span><br><span class="line">Installing ri documentation for redis-4.0.1</span><br><span class="line">Done installing documentation for redis after 2 seconds</span><br><span class="line">1 gem installed</span><br></pre></td></tr></table></figure>

<p><strong>5、执行redis-trib.rb命令</strong></p>
<p>以上表示安装成功，可以执行<code>redis-trib.rb</code>命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd src </span><br><span class="line"><span class="meta">#</span><span class="bash">执行redis-trib.rb命令</span></span><br><span class="line">./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 \</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span></span><br></pre></td></tr></table></figure>

<p>参数<code>create</code>表示创建一个新的集群，<code>--replicas 1</code>表示为每个master创建一个slave。</p>
<p>如果创建成功会显示以下信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[OK] All 16384 slots covered</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 src]# ./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 \</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Creating cluster</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Using 3 masters:</span><br><span class="line">127.0.0.1:7000</span><br><span class="line">127.0.0.1:7001</span><br><span class="line">127.0.0.1:7002</span><br><span class="line">Adding replica 127.0.0.1:7004 to 127.0.0.1:7000</span><br><span class="line">Adding replica 127.0.0.1:7005 to 127.0.0.1:7001</span><br><span class="line">Adding replica 127.0.0.1:7003 to 127.0.0.1:7002</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">M: 13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">M: be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003</span><br><span class="line">   replicates 13d0c397604a0b2644244c37b666fce83f29faa8</span><br><span class="line">S: dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004</span><br><span class="line">   replicates be2718476eba4e56f696e56b75e67df720b7fc24</span><br><span class="line">S: 99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005</span><br><span class="line">   replicates d5a834d075fd93eefab877c6ebb86efff680650f</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join....</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span></span><br><span class="line">M: d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 13d0c397604a0b2644244c37b666fce83f29faa8</span><br><span class="line">S: 99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates d5a834d075fd93eefab877c6ebb86efff680650f</span><br><span class="line">S: dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates be2718476eba4e56f696e56b75e67df720b7fc24</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<h4 id="2-1-3-部署结果验证"><a href="#2-1-3-部署结果验证" class="headerlink" title="2.1.3 部署结果验证"></a>2.1.3 部署结果验证</h4><p><strong>1、客户端访问</strong></p>
<p>使用客户端<code>redis-cli</code>二进制访问某个实例，执行<code>set</code>和<code>get</code>的测试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -c -p 7000</span></span><br><span class="line">redis 127.0.0.1:7000&gt; set foo bar</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [12182] located at 127.0.0.1:7002</span></span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:7002&gt; set hello world</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [866] located at 127.0.0.1:7000</span></span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:7000&gt; get foo</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [12182] located at 127.0.0.1:7002</span></span><br><span class="line">"bar"</span><br><span class="line">redis 127.0.0.1:7000&gt; get hello</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [866] located at 127.0.0.1:7000</span></span><br><span class="line">"world"</span><br></pre></td></tr></table></figure>

<p><strong>2、查看集群状态</strong></p>
<p>使用<code>cluster info</code>命令查看集群状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7000&gt; cluster info</span><br><span class="line">cluster_state:ok                       #集群状态</span><br><span class="line">cluster_slots_assigned:16384           #被分配的槽位数</span><br><span class="line">cluster_slots_ok:16384                 #正确分配的槽位</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6                  #当前节点</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:48273</span><br><span class="line">cluster_stats_messages_pong_sent:49884</span><br><span class="line">cluster_stats_messages_sent:98157</span><br><span class="line">cluster_stats_messages_ping_received:49879</span><br><span class="line">cluster_stats_messages_pong_received:48273</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:98157</span><br></pre></td></tr></table></figure>

<p><strong>3、查看节点状态</strong></p>
<p>使用<code>cluster nodes</code>命令查看节点状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7000&gt; cluster nodes</span><br><span class="line">be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002@17002 master - 0 1517303607000 3 connected 10923-16383</span><br><span class="line">13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001@17001 master - 0 1517303606000 2 connected 5461-10922</span><br><span class="line">3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003@17003 slave 13d0c397604a0b2644244c37b666fce83f29faa8 0 1517303606030 4 connected</span><br><span class="line">d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000@17000 myself,master - 0 1517303604000 1 connected 0-5460</span><br><span class="line">99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005@17005 slave d5a834d075fd93eefab877c6ebb86efff680650f 0 1517303607060 6 connected</span><br><span class="line">dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004@17004 slave be2718476eba4e56f696e56b75e67df720b7fc24 0 1517303608082 5 connected</span><br></pre></td></tr></table></figure>



<p> 参考文章：</p>
<p><a href="https://redis.io/download" target="_blank" rel="noopener">https://redis.io/download</a></p>
<p><a href="https://redis.io/topics/cluster-tutorial" target="_blank" rel="noopener">https://redis.io/topics/cluster-tutorial</a></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2018/04/17/redis/redis-sentinel/">
      [Redis] Redis哨兵模式部署
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Apr 17, 2018</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-部署Redis集群"><a href="#1-部署Redis集群" class="headerlink" title="1. 部署Redis集群"></a>1. 部署Redis集群</h2><p>redis的安装及配置参考[redis部署]</p>
<blockquote>
<p>本文以创建一主二从的集群为例。</p>
</blockquote>
<h3 id="1-1-部署与配置"><a href="#1-1-部署与配置" class="headerlink" title="1.1 部署与配置"></a>1.1 部署与配置</h3><p>先创建<code>sentinel</code>目录，在该目录下创建<code>8000</code>，<code>8001</code>，<code>8002</code>三个以端口号命名的目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir sentinel</span><br><span class="line">cd sentinel</span><br><span class="line">mkdir 8000 8001 8002</span><br></pre></td></tr></table></figure>

<p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 守护进程模式</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> pid file</span></span><br><span class="line">pidfile /var/run/redis.pid</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 监听端口</span></span><br><span class="line">port 8000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TCP接收队列长度，受/proc/sys/net/core/somaxconn和tcp_max_syn_backlog这两个内核参数的影响</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一个客户端空闲多少秒后关闭连接(0代表禁用，永不关闭)</span></span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果非零，则设置SO_KEEPALIVE选项来向空闲连接的客户端发送ACK</span></span><br><span class="line">tcp-keepalive 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定服务器调试等级</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可能值：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> debug （大量信息，对开发/测试有用）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verbose （很多精简的有用信息，但是不像debug等级那么多）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> notice （适量的信息，基本上是你生产环境中需要的）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> warning （只有很重要/严重的信息会记录下来）</span></span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指明日志文件名</span></span><br><span class="line">logfile "./redis8000.log"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置数据库个数</span></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 会在指定秒数和数据变化次数之后把数据库写到磁盘上</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 900秒（15分钟）之后，且至少1次变更</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 300秒（5分钟）之后，且至少10次变更</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 60秒之后，且至少10000次变更</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当导出到 .rdb 数据库时是否用LZF压缩字符串对象</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 持久化数据库的文件名</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 工作目录</span></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当master服务设置了密码保护时，slave服务连接master的密码</span></span><br><span class="line">masterauth 0234kz9*l</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一个slave失去和master的连接，或者同步正在进行中，slave的行为可以有两种：</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1) 如果 slave-serve-stale-data 设置为 <span class="string">"yes"</span> (默认值)，slave会继续响应客户端请求，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可能是正常数据，或者是过时了的数据，也可能是还没获得值的空数据。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2) 如果 slave-serve-stale-data 设置为 <span class="string">"no"</span>，slave会回复<span class="string">"正在从master同步</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> （SYNC with master <span class="keyword">in</span> progress）<span class="string">"来处理各种请求，除了 INFO 和 SLAVEOF 命令。</span></span></span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 你可以配置salve实例是否接受写操作。可写的slave实例可能对存储临时数据比较有用(因为写入salve</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 的数据在同master同步之后将很容易被删除</span></span><br><span class="line">slave-read-only yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否在slave套接字发送SYNC之后禁用 TCP_NODELAY？</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到slave</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上有延迟，Linux内核的默认配置会达到40毫秒</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你选择了 <span class="string">"no"</span> 数据传输到salve的延迟将会减少但要使用更多的带宽</span></span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> slave的优先级是一个整数展示在Redis的Info输出中。如果master不再正常工作了，哨兵将用它来</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选择一个slave提升=升为master。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 优先级数字小的salve会优先考虑提升为master，所以例如有三个slave优先级分别为10，100，25，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵将挑选优先级最小数字为10的slave。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 0作为一个特殊的优先级，标识这个slave不能作为master，所以一个优先级为0的slave永远不会被</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵挑选提升为master</span></span><br><span class="line">slave-priority 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码验证</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一个高强度的密码，否则破解太容易了</span></span><br><span class="line">requirepass 0234kz9*l</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis实例最大占用内存，不要用比设置的上限更多的内存。一旦内存使用达到上限，Redis会根据选定的回收策略（参见：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> maxmemmory-policy）删除key</span></span><br><span class="line">maxmemory 3gb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大内存策略：如果达到内存限制了，Redis如何选择删除key。你可以在下面五个行为里选：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-lru -&gt; 根据LRU算法删除带有过期时间的key。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-lru -&gt; 根据LRU算法删除任何key。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-random -&gt; 根据过期设置来随机删除key, 具备过期时间的key。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-&gt;random -&gt; 无差别随机删, 任何一个key。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-ttl -&gt; 根据最近过期时间来删除（辅以TTL）, 这是对于有过期时间的key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> noeviction -&gt; 谁也不删，直接在写操作时返回错误。</span></span><br><span class="line">maxmemory-policy volatile-lru</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下，Redis是异步的把数据导出到磁盘上。这种模式在很多应用里已经足够好，但Redis进程</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 出问题或断电时可能造成一段时间的写操作丢失(这取决于配置的save指令)。</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF是一种提供了更可靠的替代持久化模式，例如使用默认的数据写入文件策略（参见后面的配置）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在遇到像服务器断电或单写情况下Redis自身进程出问题但操作系统仍正常运行等突发事件时，Redis</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 能只丢失1秒的写操作。</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF和RDB持久化能同时启动并且不会有问题。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果AOF开启，那么在启动时Redis将加载AOF文件，它更能保证数据的可靠性。</span></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> aof文件名</span></span><br><span class="line">appendfilename "appendonly.aof"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> fsync() 系统调用告诉操作系统把数据写到磁盘上，而不是等更多的数据进入输出缓冲区。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 有些操作系统会真的把数据马上刷到磁盘上；有些则会尽快去尝试这么做。</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis支持三种不同的模式：</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> no：不要立刻刷，只有在操作系统需要刷的时候再刷。比较快。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> always：每次写操作都立刻写入到aof文件。慢，但是最安全。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> everysec：每秒写一次。折中方案。</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果AOF的同步策略设置成 <span class="string">"always"</span> 或者 <span class="string">"everysec"</span>，并且后台的存储进程（后台存储或写入AOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志）会产生很多磁盘I/O开销。某些Linux的配置下会使Redis因为 fsync()系统调用而阻塞很久。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意，目前对这个情况还没有完美修正，甚至不同线程的 fsync() 会阻塞我们同步的write(2)调用。</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为了缓解这个问题，可以用下面这个选项。它可以在 BGSAVE 或 BGREWRITEAOF 处理时阻止主进程进行fsync()。</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这就意味着如果有子进程在进行保存操作，那么Redis就处于<span class="string">"不可同步"</span>的状态。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这实际上是说，在最差的情况下可能会丢掉30秒钟的日志数据。（默认Linux设定）</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果你有延时问题把这个设置成<span class="string">"yes"</span>，否则就保持<span class="string">"no"</span>，这是保存持久数据的最安全的方式。</span></span><br><span class="line">no-appendfsync-on-rewrite yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自动重写AOF文件</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF文件可能在尾部是不完整的（这跟system关闭有问题，尤其是mount ext4文件系统时</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 没有加上data=ordered选项。只会发生在os死时，redis自己死不会不完整）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 那redis重启时load进内存的时候就有问题了。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发生的时候，可以选择redis启动报错，并且通知用户和写日志，或者load尽量多正常的数据。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果aof-load-truncated是yes，会自动发布一个<span class="built_in">log</span>给客户端然后load（默认）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是no，用户必须手动redis-check-aof修复AOF文件才可以。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意，如果在读取的过程中，发现这个aof是损坏的，服务器也是会退出的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个选项仅仅用于当服务器尝试读取更多的数据但又找不到相应的数据时。</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Lua 脚本的最大执行时间，毫秒为单位</span></span><br><span class="line">lua-time-limit 5000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis慢查询日志可以记录超过指定时间的查询</span></span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个长度没有限制。只是要主要会消耗内存。你可以通过 SLOWLOG RESET 来回收内存。</span></span><br><span class="line">slowlog-max-len 128</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis延时监控系统在运行时会采样一些操作，以便收集可能导致延时的数据根源。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过 LATENCY命令 可以打印一些图样和获取一些报告，方便监控</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个系统仅仅记录那个执行时间大于或等于预定时间（毫秒）的操作,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个预定时间是通过latency-monitor-threshold配置来指定的，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当设置为0时，这个监控系统处于停止状态</span></span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Redis能通知 Pub/Sub 客户端关于键空间发生的事件，默认关闭</span></span><br><span class="line">notify-keyspace-events ""</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当<span class="built_in">hash</span>只有少量的entry时，并且最大的entry所占空间没有超过指定的限制时，会用一种节省内存的</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数据结构来编码。可以通过下面的指令来设定限制</span></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与<span class="built_in">hash</span>似，数据元素较少的list，可以用另一种方式来编码从而节省大量空间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种特殊的方式只有在符合下面限制时才可以用</span></span><br><span class="line">list-max-ziplist-entries 512</span><br><span class="line">list-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span>有一种特殊编码的情况：当<span class="built_in">set</span>数据全是十进制64位有符号整型数字构成的字符串时。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面这个配置项就是用来设置<span class="built_in">set</span>使用这种编码来节省内存的最大长度。</span></span><br><span class="line">set-max-intset-entries 512</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 与<span class="built_in">hash</span>和list相似，有序集合也可以用一种特别的编码方式来节省大量空间。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种编码只适合长度和元素都小于下面限制的有序集合</span></span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HyperLogLog稀疏结构表示字节的限制。该限制包括</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 16个字节的头。当HyperLogLog使用稀疏结构表示</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这些限制，它会被转换成密度表示。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 值大于16000是完全没用的，因为在该点</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 密集的表示是更多的内存效率。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 建议值是3000左右，以便具有的内存好处, 减少内存的消耗</span></span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用哈希刷新，每100个CPU毫秒会拿出1个毫秒来刷新Redis的主哈希表（顶级键值映射表）</span></span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端的输出缓冲区的限制，可用于强制断开那些因为某种原因从服务器读取数据的速度不够快的客户端</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认情况下，“hz”的被设定为10。提高该值将在Redis空闲时使用更多的CPU时，但同时当有多个key</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时到期会使Redis的反应更灵敏，以及超时可以更精确地处理</span></span><br><span class="line">hz 10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当一个子进程重写AOF文件时，如果启用下面的选项，则文件每生成32M数据会被同步</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>

<h3 id="1-2-配置主从关系"><a href="#1-2-配置主从关系" class="headerlink" title="1.2 配置主从关系"></a>1.2 配置主从关系</h3><p><strong>1、启动实例</strong></p>
<p>三个Redis实例配置相同，分别启动三个Redis实例。建议将<code>redis-server</code>、<code>redis-cli</code>、<code>redis-sentinel</code>的二进制复制到<code>/usr/local/bin</code>的目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd 8000</span><br><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure>

<p><strong>2、配置主从关系</strong></p>
<p>例如，将8000端口实例设为主，8001和8002端口的实例设为从。</p>
<p>则分别登录8001和8002的实例，执行<code>slaveof &lt;MASTER_IP&gt; &lt;MASTER_PORT&gt;</code>命令。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 8000]# redis-cli -c -p 8001 -a 0234kz9*l</span><br><span class="line">127.0.0.1:8001&gt; slaveof 127.0.0.1 8000</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p><strong>3、检查集群状态</strong></p>
<p>登录master和slave实例，执行<code>info replication</code>查看集群状态。</p>
<p>Master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 8000]# redis-cli -c -p 8000 -a 0234kz9*l</span><br><span class="line">127.0.0.1:8000&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=8001,state=online,offset=2853,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=8002,state=online,offset=2853,lag=0</span><br><span class="line">master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:2853</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2853</span><br></pre></td></tr></table></figure>

<p>Slave</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 8000]# redis-cli -c -p 8001 -a 0234kz9*l</span><br><span class="line">127.0.0.1:8001&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:8000</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:3</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:2909</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:2909</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2909</span><br></pre></td></tr></table></figure>

<p>也可以往master写数据，从slave读取数据来验证。</p>
<h2 id="2-部署sentinel集群"><a href="#2-部署sentinel集群" class="headerlink" title="2. 部署sentinel集群"></a>2. 部署sentinel集群</h2><h3 id="2-1-部署与配置"><a href="#2-1-部署与配置" class="headerlink" title="2.1 部署与配置"></a>2.1 部署与配置</h3><p>在之前创建的<code>sentinel</code>目录中场景sentinel端口号命名的目录<code>28000</code>，<code>28001</code>，<code>28002</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd sentinel</span><br><span class="line">mkdir 28000 28001 28002</span><br></pre></td></tr></table></figure>

<p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 28000</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 8000 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></table></figure>

<h3 id="2-2-启动sentinel实例"><a href="#2-2-启动sentinel实例" class="headerlink" title="2.2 启动sentinel实例"></a>2.2 启动sentinel实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">&amp; 表示后台运行的方式</span></span><br><span class="line">redis-sentinel sentinel.conf &amp;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-查看状态"><a href="#2-3-查看状态" class="headerlink" title="2.3 查看状态"></a>2.3 查看状态</h3><p>使用<code>sentinel masters</code>命令查看监控的master节点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node-1 28000]# redis-cli -c -p 28000 -a 0234kz9*l</span><br><span class="line">127.0.0.1:28000&gt;</span><br><span class="line">127.0.0.1:28000&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:28000&gt;</span><br><span class="line">127.0.0.1:28000&gt; sentinel masters</span><br><span class="line">1)  1) "name"</span><br><span class="line">    2) "mymaster"</span><br><span class="line">    3) "ip"</span><br><span class="line">    4) "127.0.0.1"</span><br><span class="line">    5) "port"</span><br><span class="line">    6) "8000"</span><br><span class="line">    7) "runid"</span><br><span class="line">    8) ""</span><br><span class="line">    9) "flags"</span><br><span class="line">   10) "s_down,master,disconnected"</span><br><span class="line">   11) "link-pending-commands"</span><br><span class="line">   12) "0"</span><br><span class="line">   13) "link-refcount"</span><br><span class="line">   14) "1"</span><br><span class="line">   15) "last-ping-sent"</span><br><span class="line">   16) "187539"</span><br><span class="line">   17) "last-ok-ping-reply"</span><br><span class="line">   18) "187539"</span><br><span class="line">   19) "last-ping-reply"</span><br><span class="line">   20) "3943"</span><br><span class="line">   21) "s-down-time"</span><br><span class="line">   22) "127491"</span><br><span class="line">   23) "down-after-milliseconds"</span><br><span class="line">   24) "60000"</span><br><span class="line">   25) "info-refresh"</span><br><span class="line">   26) "1517346914642"</span><br><span class="line">   27) "role-reported"</span><br><span class="line">   28) "master"</span><br><span class="line">   29) "role-reported-time"</span><br><span class="line">   30) "187539"</span><br><span class="line">   31) "config-epoch"</span><br><span class="line">   32) "0"</span><br><span class="line">   33) "num-slaves"</span><br><span class="line">   34) "0"</span><br><span class="line">   35) "num-other-sentinels"</span><br><span class="line">   36) "0"</span><br><span class="line">   37) "quorum"</span><br><span class="line">   38) "2"</span><br><span class="line">   39) "failover-timeout"</span><br><span class="line">   40) "180000"</span><br><span class="line">   41) "parallel-syncs"</span><br><span class="line">   42) "1"</span><br></pre></td></tr></table></figure>



<p>参考文章：</p>
<p><a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener">https://redis.io/topics/sentinel</a></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2017/09/13/nginx/nginx-deploy&config/">
      [Nginx] Nginx的部署与配置
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Sep 13, 2017</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-部署"><a href="#1-部署" class="headerlink" title="1. 部署"></a>1. 部署</h2><h3 id="1-1-使用安装包的方式"><a href="#1-1-使用安装包的方式" class="headerlink" title="1.1. 使用安装包的方式"></a>1.1. 使用安装包的方式</h3><p>rpm -ivh nginx-xxx.rpm</p>
<h3 id="1-2-使用源代码安装"><a href="#1-2-使用源代码安装" class="headerlink" title="1.2. 使用源代码安装"></a>1.2. 使用源代码安装</h3><h4 id="1-2-1-下载源码包"><a href="#1-2-1-下载源码包" class="headerlink" title="1.2.1. 下载源码包"></a>1.2.1. 下载源码包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.9.13.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-创建临时目录并解压源码包"><a href="#1-2-2-创建临时目录并解压源码包" class="headerlink" title="1.2.2. 创建临时目录并解压源码包"></a>1.2.2. 创建临时目录并解压源码包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir $HOME/build</span><br><span class="line">cd $HOME/build &amp;&amp; tar zxvf nginx-`version-number`.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-编译并安装"><a href="#1-2-3-编译并安装" class="headerlink" title="1.2.3. 编译并安装"></a>1.2.3. 编译并安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> cd $HOME/build/nginx-`version-number`</span><br><span class="line"> </span><br><span class="line">./configure \</span><br><span class="line">--prefix=/etc/nginx \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash">`更多配置项见以下说明`</span></span><br><span class="line"> </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h4 id="1-2-4-配置项"><a href="#1-2-4-配置项" class="headerlink" title="1.2.4. 配置项"></a>1.2.4. 配置项</h4><h5 id="1-2-4-1-通用配置项"><a href="#1-2-4-1-通用配置项" class="headerlink" title="1.2.4.1. 通用配置项"></a>1.2.4.1. 通用配置项</h5><table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>–prefix=<code>path</code></td>
<td>nginx安装的根路径，所有其他的路径都要依赖与该选项</td>
</tr>
<tr>
<td>–sbin-path=<code>path</code></td>
<td>nginx二进制文件的路径，如果没有指定则会依赖于–prefix</td>
</tr>
<tr>
<td>–conf-path=<code>path</code></td>
<td>如果在命令行中没有指定配置文件，则通过该配置项去查找配置文件</td>
</tr>
<tr>
<td>–error-log-path=<code>path</code></td>
<td>指定错误文件的路径</td>
</tr>
<tr>
<td>–pid-path=<code>path</code></td>
<td>指定的文件将会写入nginx master进程的pid，通常在/var/run下</td>
</tr>
<tr>
<td>–lock-path=<code>path</code></td>
<td>共享存储器互斥锁文件的路径</td>
</tr>
<tr>
<td>–user=<code>user</code></td>
<td>worker进程运行的用户</td>
</tr>
<tr>
<td>–group=<code>group</code></td>
<td>worker进程运行的组</td>
</tr>
<tr>
<td>–with-file-aio</td>
<td>启动异步I/O</td>
</tr>
<tr>
<td>–with-debug</td>
<td>启用调试日志，生产环境不推荐配置</td>
</tr>
</tbody></table>
<h5 id="1-2-4-2-优化配置项"><a href="#1-2-4-2-优化配置项" class="headerlink" title="1.2.4.2. 优化配置项"></a>1.2.4.2. 优化配置项</h5><table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>–with-cc=<code>path</code></td>
<td>如果想设置一个不在默认PATH下的C编译器</td>
</tr>
<tr>
<td>–with-cpp=<code>path</code></td>
<td>设置C预处理器的相应路径</td>
</tr>
<tr>
<td>–with-cc-opt=<code>options</code></td>
<td>指定必要的include文件路径</td>
</tr>
<tr>
<td>–with-ld-opt=<code>options</code></td>
<td>包含连接器库的路径和运行路径</td>
</tr>
<tr>
<td>–with-cpu-opt=<code>cpu</code></td>
<td>通过该选项为特定的CPU构建nginx</td>
</tr>
</tbody></table>
<h5 id="1-2-4-3-http模块的配置项"><a href="#1-2-4-3-http模块的配置项" class="headerlink" title="1.2.4.3. http模块的配置项"></a>1.2.4.3. http模块的配置项</h5><table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>–without-http-cache</td>
<td>在使用upstream模块时，nginx能够配置本地缓存内容，该选项可以禁用缓存</td>
</tr>
<tr>
<td>–with-http_perl_module</td>
<td>nginx配置能够扩展使用perl代码。该项启用这个模块，但会降低性能</td>
</tr>
<tr>
<td>–with-perl_modules_path=<code>path</code></td>
<td>对于额外嵌入的perl模块，该选项指定该perl解析器的路径</td>
</tr>
<tr>
<td>–with-perl=<code>path</code></td>
<td>如果在默认的路径中找不到perl则指定perl（5.6版本以上）的路径</td>
</tr>
<tr>
<td>–http-log-path=<code>path</code></td>
<td>http访问日志的默认路径</td>
</tr>
<tr>
<td>–http-client-body-temp-path=<code>path</code></td>
<td>从客户端收到请求后，该项用于作为请求体临时存放的目录</td>
</tr>
<tr>
<td>–http-proxy-temp-path=<code>path</code></td>
<td>在使用代理后，通过该项设置存放临时文件路径</td>
</tr>
<tr>
<td>–http-fastcgi-temp-path=<code>path</code></td>
<td>设置FastCGI临时文件的目录</td>
</tr>
<tr>
<td>–http-uwsgi-temp-path=<code>path</code></td>
<td>设置uWSGI临时文件的目录</td>
</tr>
<tr>
<td>–http-scgi-temp-path=<code>path</code></td>
<td>设置SCGI临时文件的目录</td>
</tr>
</tbody></table>
<h5 id="1-2-4-4-其他模块额外配置项"><a href="#1-2-4-4-其他模块额外配置项" class="headerlink" title="1.2.4.4. 其他模块额外配置项"></a>1.2.4.4. 其他模块额外配置项</h5><p>默认没有安装这些模块，可以通过–with-<code>module-name</code>_module来启用相应的模块功能。</p>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>–with-http_ssl_module</td>
<td>如果需要对流量进行加密，可以使用该选项，再URLs中开始部分将会是https(需要OpenSSL库)</td>
</tr>
<tr>
<td>–with-http_realip_module</td>
<td>如果nginx在七层负载均衡器或者其他设备之后，它们将Http头中的客户端IP地址传递，则需要启用该模块，再多个客户处于一个IP地址的情况下使用</td>
</tr>
<tr>
<td>–with-http_addition_module</td>
<td>该模块作为输出过滤器，使能够在请求经过一个location前或后时在该location本身添加内容</td>
</tr>
<tr>
<td>–with-http_xslt_module</td>
<td>该模块用于处理XML响应转换，基于一个或多个XSLT格式</td>
</tr>
<tr>
<td>–with-http_image_filter_module</td>
<td>该模块被作为图像过滤器使用，在将图像投递到客户之前进行处理（需要libgd库）</td>
</tr>
<tr>
<td>–with-http_geoip_module</td>
<td>使用该模块，能够设置各种变量以便在配置文件中的区段使用，基于地理位置查找客户端IP地址</td>
</tr>
<tr>
<td>–with-http_sub_module</td>
<td>该模块实现替代过滤，在响应中用一个字符串替代另一个字符串</td>
</tr>
<tr>
<td>–with-heep_dav_module</td>
<td>启用这个模块将激活使用WebDAV的配置指令。</td>
</tr>
<tr>
<td>–with-http_flv_module</td>
<td>如果需要提供Flash流媒体视频文件，那么该模块将会提供伪流媒体</td>
</tr>
<tr>
<td>–with-http_mp4_module</td>
<td>这个模块支持H.264/AAC文件伪流媒体</td>
</tr>
<tr>
<td>–with-http_gzip_static_module</td>
<td>当被调用的资源没有.gz结尾格式的文件时，如果想支持发送预压缩版本的静态文件，那么使用该模块</td>
</tr>
<tr>
<td>–with-http_gunzip_module</td>
<td>对于不支持gzip编码的客户，该模块用于为客户解压缩预压缩内容</td>
</tr>
<tr>
<td>–with-http_random_index_module</td>
<td>如果你想提供从一个目录中随机选择文件的索引文件，那么该模块需要激活</td>
</tr>
<tr>
<td>–with-http_secure_link_module</td>
<td>该模块提供一种机制，它会将一个哈希值链接到一个URL中，因此只有那些使用正确密码能够计算链接</td>
</tr>
<tr>
<td>–with-http_stub_status_module</td>
<td>启用这个模块后会收集Nginx自身的状态信息。输出的状态信息可以使用RRDtool或类似的东西绘制成图</td>
</tr>
</tbody></table>
<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h2><p>配置文件一般为/etc/nginx/nginx.conf或/usr/local/nginx/conf/nginx.conf。</p>
<h3 id="2-1-基本配置格式"><a href="#2-1-基本配置格式" class="headerlink" title="2.1. 基本配置格式"></a>2.1. 基本配置格式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`section`&#123;</span><br><span class="line">    `directive` `parameters`;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一个指令行由分号结束，大括号{}表示一个新的上下文。</p>
<h3 id="2-2-Nginx全局配置参数"><a href="#2-2-Nginx全局配置参数" class="headerlink" title="2.2. Nginx全局配置参数"></a>2.2. Nginx全局配置参数</h3><p>全局配置指令</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>main模块</td>
<td>user</td>
<td>配置worker进程的用户和组，如果忽略group，则group等于指定的用户的所属组</td>
</tr>
<tr>
<td>worker_processes</td>
<td>指定worker进程的启动数量，可将其设置为可用的CPU内核数，若为auto为自动检测</td>
<td></td>
</tr>
<tr>
<td>error_log</td>
<td>所有错误的写入文件，第二个参数指定错误的级别（debug，info，notice，warn，error，crit，alert，emerg）</td>
<td></td>
</tr>
<tr>
<td>pid</td>
<td>设置主进程IP的文件</td>
<td></td>
</tr>
<tr>
<td>events模块</td>
<td>use</td>
<td>用于设置使用什么样的连接方法</td>
</tr>
<tr>
<td>worker_connections</td>
<td>用于配置一个工作进程能够接受的并发连接最大数。包括客户连接和向上游服务器的连接。</td>
<td></td>
</tr>
</tbody></table>
<h3 id="2-3-使用include文件"><a href="#2-3-使用include文件" class="headerlink" title="2.3. 使用include文件"></a>2.3. 使用include文件</h3><p>include文件可以在任何地方以增强配置文件的可读性，使用include文件要确保被包含文件自身正确的nginx语法，即配置指令和块，然后指定这些文件的路径。</p>
<p>include /etc/nginx/mime.types;</p>
<p>若使用通配符则表示通配的多个文件，若没有给定全路径则依据主配置文件路径进行搜索。</p>
<p>include /etc/nginx/conf.d/*.conf</p>
<p>测试配置文件(包括include的配置文件)语法：</p>
<p>nginx -t -c path-to-nginx.conf</p>
<h3 id="2-4-配置说明"><a href="#2-4-配置说明" class="headerlink" title="2.4. 配置说明"></a>2.4. 配置说明</h3><h4 id="2-4-1-main模块"><a href="#2-4-1-main模块" class="headerlink" title="2.4.1. main模块"></a>2.4.1. main模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">main模块类似main函数包含其他子模块，非模块配置项(包括模块内)分号结尾，子模块配置花括号结尾</span></span><br><span class="line">user nobady;   #一般按默认设置</span><br><span class="line">pid /var/run/nginx.pid;   #进程标识符存放路径，一般按默认设置</span><br><span class="line">worker_processes auto;   #nginx对外提供web服务时的worder进程数，可将其设置为可用的CPU内核数，auto为自动检测</span><br><span class="line">worker_rlimit_nofile 100000;  # 更改worker进程的最大打开文件数限制</span><br><span class="line">error_log logs/error.log  info;   #错误日志存放路径</span><br><span class="line">keepalive_timeout 60;  #keepalive_timeout 60;</span><br><span class="line">events&#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">见events模块</span></span><br><span class="line">&#125;</span><br><span class="line">http&#123;  #见http模块</span><br><span class="line">  server&#123; </span><br><span class="line">    ...</span><br><span class="line">    location /&#123;</span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">mail&#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">见mail模块</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-events模块"><a href="#2-4-2-events模块" class="headerlink" title="2.4.2. events模块"></a>2.4.2. events模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">  worker_connections 2048;    #设置可由一个worker进程同时打开的最大连接数</span><br><span class="line">  multi_accept on;   #告诉nginx收到一个新连接通知后接受尽可能多的连接</span><br><span class="line">  use epoll; #设置用于复用客户端线程的轮询方法。Linux 2.6+：使用epoll；*BSD：使用kqueue。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-3-http模块"><a href="#2-4-3-http模块" class="headerlink" title="2.4.3. http模块"></a>2.4.3. http模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">http &#123;  #http模块</span><br><span class="line">    server &#123;  #server模块，http服务上的虚拟主机， server 当做对应一个域名进行的配置</span><br><span class="line">        listen          80;  #配置监听端口</span><br><span class="line">        server_name     www.linuxidc.com; #配置访问域名</span><br><span class="line">        access_log      logs/linuxidc.access.log main;  #指定日志文件的存放路径</span><br><span class="line">        index index.html;    #默认访问页面</span><br><span class="line">        root  /var/www/androidj.com/htdocs;  # root 是指将本地的一个文件夹作为所有 url 请求的根路径</span><br><span class="line">        upstream backend &#123;   #反向代理的后端机器，实现负载均衡</span><br><span class="line">            ip_hash;    #指明了我们均衡的方式是按照用户的 ip 地址进行分配</span><br><span class="line">            server backend1.example.com;</span><br><span class="line">            server backend2.example.com;</span><br><span class="line">            server backend3.example.com;</span><br><span class="line">            server backend4.example.com;</span><br><span class="line">        &#125;</span><br><span class="line">        location / &#123;  #location 是在一个域名下对更精细的路径进行配置</span><br><span class="line">            proxy_pass http://backend;  #反向代理到后端机器</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen          80;</span><br><span class="line">        server_name     www.Androidj.com;</span><br><span class="line">        access_log      logs/androidj.access.log main;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.html;</span><br><span class="line">            root  /var/www/androidj.com/htdocs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-4-mail模块"><a href="#2-4-4-mail模块" class="headerlink" title="2.4.4. mail模块"></a>2.4.4. mail模块</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mail &#123;</span><br><span class="line">    auth_http  127.0.0.1:80/auth.php;</span><br><span class="line">    pop3_capabilities  "TOP"  "USER";</span><br><span class="line">    imap_capabilities  "IMAP4rev1"  "UIDPLUS";</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen     110;</span><br><span class="line">        protocol   pop3;</span><br><span class="line">        proxy      on;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen      25;</span><br><span class="line">        protocol    smtp;</span><br><span class="line">        proxy       on;</span><br><span class="line">        smtp_auth   login plain;</span><br><span class="line">        xclient     off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2017/07/15/redis/redis-introduction/">
      [Redis] Redis介绍
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jul 15, 2017</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、redis是什么？（what）"><a href="#一、redis是什么？（what）" class="headerlink" title="一、redis是什么？（what）"></a>一、redis是什么？（what）</h2><p>Redis是一个开源（BSD许可），内存存储的数据结构服务器，可用作数据库，高速缓存和消息队列代理。它支持字符串、哈希表、列表、集合、有序集合，位图，hyperloglogs等数据类型。内置复制、Lua脚本、LRU收回、事务以及不同级别磁盘持久化功能，同时通过Redis Sentinel提供高可用，通过Redis Cluster提供自动分区。</p>
<p>Redis是一个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p>
<h2 id="二、为什么使用redis？（why）"><a href="#二、为什么使用redis？（why）" class="headerlink" title="二、为什么使用redis？（why）"></a>二、为什么使用redis？（why）</h2><h3 id="（一）redis的特点"><a href="#（一）redis的特点" class="headerlink" title="（一）redis的特点"></a>（一）redis的特点</h3><ol>
<li>Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ol>
<h3 id="（二）redis的优势"><a href="#（二）redis的优势" class="headerlink" title="（二）redis的优势"></a>（二）redis的优势</h3><ol>
<li>性能极高 – Redis能读的速度是110000次/s,写的速度是81000次/s 。</li>
<li>丰富的数据类型 – Redis支持二进制案例的 Strings, Lists, Hashes, Sets 及 Ordered Sets 数据类型操作。</li>
<li>原子 – Redis的所有操作都是原子性的，同时Redis还支持对几个操作全并后的原子性执行。</li>
<li>丰富的特性 – Redis还支持 publish/subscribe, 通知, key 过期等等特性。</li>
</ol>
<h3 id="（三）redis与其他key-value存储有什么不同"><a href="#（三）redis与其他key-value存储有什么不同" class="headerlink" title="（三）redis与其他key-value存储有什么不同"></a>（三）redis与其他key-value存储有什么不同</h3><ol>
<li>Redis有着更为复杂的数据结构并且提供对他们的原子性操作，Redis的数据类型都是基于基本数据结构的同时对程序员透明，无需进行额外的抽象。</li>
<li>Redis运行在内存中但是可以持久化到磁盘，所以在对不同数据集进行高速读写时需要权衡内存，应为数据量不能大于硬件内存。</li>
<li>相比在磁盘上相同的复杂的数据结构，在内存中操作起来非常简单，这样Redis可以做很多内部复杂性很强的事情。</li>
<li>在磁盘格式方面他们是紧凑的以追加的方式产生的，因为他们并不需要进行随机访问。</li>
</ol>
<h2 id="三、如何使用redis？（how）"><a href="#三、如何使用redis？（how）" class="headerlink" title="三、如何使用redis？（how）"></a>三、如何使用redis？（how）</h2><h3 id="（一）redis的数据类型"><a href="#（一）redis的数据类型" class="headerlink" title="（一）redis的数据类型"></a>（一）redis的数据类型</h3><table>
<thead>
<tr>
<th>数据类型</th>
<th>概念</th>
<th>常用命令</th>
</tr>
</thead>
<tbody><tr>
<td>String(字符串)</td>
<td>key-value型</td>
<td>SET ，GET</td>
</tr>
<tr>
<td>Hash(哈希)</td>
<td>field-value,适用于存储对象类型（对象名-对象属性值）</td>
<td>HMSET，HEGTALL</td>
</tr>
<tr>
<td>List(列表)</td>
<td>string类型的有序列表，按照插入顺序排序</td>
<td>lpush，lrange</td>
</tr>
<tr>
<td>Set(集合)</td>
<td>string类型的无序集合</td>
<td>sadd，smembers</td>
</tr>
<tr>
<td>zset(sorted set：有序集合)</td>
<td>string类型元素的集合,且不允许重复的成员。每个元素关联一个double值来进行排序，double值可以重复但元素不能重复。</td>
<td>zadd，ZRANGEBYSCORE</td>
</tr>
</tbody></table>
<h3 id="（二）redis常用命令"><a href="#（二）redis常用命令" class="headerlink" title="（二）redis常用命令"></a>（二）redis常用命令</h3>
      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2017/07/09/docker/dockerfile-usage/">
      [Docker] Dockerfile使用说明
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jul 9, 2017</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、Dockerfile的说明"><a href="#一、Dockerfile的说明" class="headerlink" title="一、Dockerfile的说明"></a>一、Dockerfile的说明</h2><p>dockerfile指令忽略大小写，建议大写，#作为注释，每行只支持一条指令，指令可以带多个参数。</p>
<p>dockerfile指令分为构建指令和设置指令。</p>
<ol>
<li>构建指令：用于构建image，其指定的操作不会在运行image的容器中执行。</li>
<li>设置指令：用于设置image的属性，其指定的操作会在运行image的容器中执行。</li>
</ol>
<h2 id="二、Dockerfile指令说明"><a href="#二、Dockerfile指令说明" class="headerlink" title="二、Dockerfile指令说明"></a>二、Dockerfile指令说明</h2><h3 id="1、FROM（指定基础镜像）-构建指令"><a href="#1、FROM（指定基础镜像）-构建指令" class="headerlink" title="1、FROM（指定基础镜像）[构建指令]"></a>1、FROM（指定基础镜像）[构建指令]</h3><p>该命令用来指定基础镜像，在基础镜像的基础上修改数据从而构建新的镜像。基础镜像可以是本地仓库也可以是远程仓库。</p>
<p>指令有两种格式：</p>
<ol>
<li>FROM <code>image</code>   【默认为latest版本】</li>
<li>FROM <code>image</code>:<code>tag</code>     【指定版本】</li>
</ol>
<h3 id="2、MAINTAINER（镜像创建者信息）-构建指令"><a href="#2、MAINTAINER（镜像创建者信息）-构建指令" class="headerlink" title="2、MAINTAINER（镜像创建者信息）[构建指令]"></a>2、MAINTAINER（镜像创建者信息）[构建指令]</h3><p>将镜像制作者（维护者）的信息写入image中，执行docker inspect时会输出该信息。</p>
<p>格式：MAINTAINER <code>name</code></p>
<h3 id="3、RUN（安装软件用）-构建指令"><a href="#3、RUN（安装软件用）-构建指令" class="headerlink" title="3、RUN（安装软件用）[构建指令]"></a>3、RUN（安装软件用）[构建指令]</h3><p>RUN可以运行任何被基础镜像支持的命令（即在基础镜像上执行一个进程），可以使用多条RUN指令，指令较长可以使用\来换行。</p>
<p>指令有两种格式：</p>
<ol>
<li>RUN <code>command</code> (the command is run in a shell - <code>/bin/sh -c</code>)</li>
<li>RUN [“executable”, “param1”, “param2” … ] (exec form) <ul>
<li>指定使用其他终端实现，使用exec执行。</li>
<li>例子：RUN[“/bin/bash”,”-c”,”echo hello”]</li>
</ul>
</li>
</ol>
<h3 id="4、CMD（设置container启动时执行的操作）-设置指令"><a href="#4、CMD（设置container启动时执行的操作）-设置指令" class="headerlink" title="4、CMD（设置container启动时执行的操作）[设置指令]"></a>4、CMD（设置container启动时执行的操作）[设置指令]</h3><p>用于容器启动时的指定操作，可以是自定义脚本或命令，只执行一次，多个默认执行最后一个。</p>
<p>指令有三种格式：</p>
<ol>
<li>CMD [“executable”,”param1”,”param2”] (like an exec, this is the preferred form) <ul>
<li>运行一个可执行文件并提供参数。</li>
</ul>
</li>
<li>CMD command param1 param2 (as a shell) <ul>
<li>直接执行shell命令，默认以/bin/sh -c执行。</li>
</ul>
</li>
<li>CMD [“param1”,”param2”] (as default parameters to ENTRYPOINT) <ul>
<li>和ENTRYPOINT配合使用，只作为完整命令的参数部分。</li>
</ul>
</li>
</ol>
<h3 id="5、ENTRYPOINT（设置container启动时执行的操作）-设置指令"><a href="#5、ENTRYPOINT（设置container启动时执行的操作）-设置指令" class="headerlink" title="5、ENTRYPOINT（设置container启动时执行的操作）[设置指令]"></a>5、ENTRYPOINT（设置container启动时执行的操作）[设置指令]</h3><p>指定容器启动时执行的命令，若多次设置只执行最后一次。</p>
<p>ENTRYPOINT翻译为“进入点”，它的功能可以让容器表现得像一个可执行程序一样。</p>
<p>例子：ENTRYPOINT [“/bin/echo”] ，那么docker build出来的镜像以后的容器功能就像一个/bin/echo程序，docker run -it imageecho “this is a test”，就会输出对应的字符串。这个imageecho镜像对应的容器表现出来的功能就像一个echo程序一样。</p>
<p>指令有两种格式：</p>
<ol>
<li><p>ENTRYPOINT [“executable”, “param1”, “param2”] (like an exec, the preferred form)</p>
<ul>
<li><p>和CMD配合使用，CMD则作为完整命令的参数部分，ENTRYPOINT以JSON格式指定执行的命令部分。CMD可以为ENTRYPOINT提供可变参数，不需要变动的参数可以写在ENTRYPOINT里面。</p>
</li>
<li><p>例子：</p>
<p>ENTRYPOINT [“/usr/bin/ls”,”-a”]</p>
<p>CMD [“-l”] </p>
</li>
</ul>
</li>
<li><p>ENTRYPOINT command param1 param2 (as a shell)</p>
<ul>
<li>独自使用，即和CMD类似，如果CMD也是个完整命令[CMD command param1 param2 (as a shell) ]，那么会相互覆盖，只执行最后一个CMD或ENTRYPOINT。</li>
<li>例子：ENTRYPOINT ls -l</li>
</ul>
</li>
</ol>
<h3 id="6、USER（设置container容器启动的登录用户）-设置指令"><a href="#6、USER（设置container容器启动的登录用户）-设置指令" class="headerlink" title="6、USER（设置container容器启动的登录用户）[设置指令]"></a>6、USER（设置container容器启动的登录用户）[设置指令]</h3><p>设置启动容器的用户，默认为root用户。</p>
<p>格式：USER daemon</p>
<h3 id="7、EXPOSE（指定容器需要映射到宿主机的端口）-设置指令"><a href="#7、EXPOSE（指定容器需要映射到宿主机的端口）-设置指令" class="headerlink" title="7、EXPOSE（指定容器需要映射到宿主机的端口）[设置指令]"></a>7、EXPOSE（指定容器需要映射到宿主机的端口）[设置指令]</h3><p>该指令会将容器中的端口映射为宿主机中的端口[确保宿主机的端口号没有被使用]。通过宿主机IP和映射后的端口即可访问容器[避免每次运行容器时IP随机生成不固定的问题]。前提是EXPOSE设置映射端口，运行容器时加上-p参数指定EXPOSE设置的端口。EXPOSE可以设置多个端口号，相应地运行容器配套多次使用-p参数。可以通过docker port +容器需要映射的端口号和容器ID来参考宿主机的映射端口。</p>
<p>格式：EXPOSE <code>port</code> [<code>port</code>…]</p>
<h3 id="8、ENV（用于设置环境变量）-构建指令"><a href="#8、ENV（用于设置环境变量）-构建指令" class="headerlink" title="8、ENV（用于设置环境变量）[构建指令]"></a>8、ENV（用于设置环境变量）[构建指令]</h3><p>在image中设置环境变量[以键值对的形式]，设置之后RUN命令可以使用该环境变量，在容器启动后也可以通过docker inspect查看环境变量或者通过 docker run –env key=value设置或修改环境变量。</p>
<p>格式：ENV <code>key</code> <code>value</code> </p>
<p>例子：ENV JAVA_HOME /path/to/java/dirent</p>
<h3 id="9、ADD（从src复制文件到container的dest路径）-构建指令"><a href="#9、ADD（从src复制文件到container的dest路径）-构建指令" class="headerlink" title="9、ADD（从src复制文件到container的dest路径）[构建指令]"></a>9、ADD（从src复制文件到container的dest路径）[构建指令]</h3><p>复制指定的src到容器中的dest，其中src是相对被构建的源目录的相对路径，可以是文件或目录的路径，也可以是一个远程的文件url。<code>dest</code> 是container中的绝对路径。所有拷贝到container中的文件和文件夹权限为0755，uid和gid为0。</p>
<ul>
<li>如果src是一个目录，那么会将该目录下的所有文件添加到container中，不包括目录；</li>
<li>如果src文件是可识别的压缩格式，则docker会帮忙解压缩（注意压缩格式）；</li>
<li>如果<code>src</code>是文件且<code>dest</code>中不使用斜杠结束，则会将<code>dest</code>视为文件，<code>src</code>的内容会写入<code>dest</code>；</li>
<li>如果<code>src</code>是文件且<code>dest</code>中使用斜杠结束，则会<code>src</code>文件拷贝到<code>dest</code>目录下。</li>
</ul>
<p>格式：ADD <code>src</code> <code>dest</code> </p>
<h3 id="10、COPY（复制文件）"><a href="#10、COPY（复制文件）" class="headerlink" title="10、COPY（复制文件）"></a>10、COPY（复制文件）</h3><p>复制本地主机的src为容器中的dest，目标路径不存在时会自动创建。</p>
<p>格式：COPY <code>src</code> <code>dest</code></p>
<h3 id="11、VOLUME（指定挂载点）-设置指令"><a href="#11、VOLUME（指定挂载点）-设置指令" class="headerlink" title="11、VOLUME（指定挂载点）[设置指令]"></a>11、VOLUME（指定挂载点）[设置指令]</h3><p>创建一个可以从本地主机或其他容器挂载的挂载点，使容器中的一个目录具有持久化存储数据的功能，该目录可以被容器本身使用也可以被其他容器使用。</p>
<p>格式：VOLUME [“<code>mountpoint</code>“] </p>
<p>其他容器使用共享数据卷：docker run -t -i -rm -volumes-from container1 image2 bash [container1为第一个容器的ID，image2为第二个容器运行image的名字。]</p>
<h3 id="12、WORKDIR（切换目录）-设置指令"><a href="#12、WORKDIR（切换目录）-设置指令" class="headerlink" title="12、WORKDIR（切换目录）[设置指令]"></a>12、WORKDIR（切换目录）[设置指令]</h3><p>相当于cd命令，可以多次切换目录，为RUN,CMD,ENTRYPOINT配置工作目录。可以使用多个WORKDIR的命令，后续命令如果是相对路径则是在上一级路径的基础上执行[类似cd的功能]。</p>
<p>格式：WORKDIR /path/to/workdir</p>
<h3 id="13、ONBUILD（在子镜像中执行）"><a href="#13、ONBUILD（在子镜像中执行）" class="headerlink" title="13、ONBUILD（在子镜像中执行）"></a>13、ONBUILD（在子镜像中执行）</h3><p>当所创建的镜像作为其他新创建镜像的基础镜像时执行的操作命令，即在创建本镜像时不运行，当作为别人的基础镜像时再在构建时运行（可认为基础镜像为父镜像，而该命令即在它的子镜像构建时运行，相当于在子镜像构建时多加了一些命令）。</p>
<p>格式：ONBUILD <code>Dockerfile关键字</code> </p>
<h2 id="三、docker-build"><a href="#三、docker-build" class="headerlink" title="三、docker build"></a>三、docker build</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Usage: docker build [OPTIONS] PATH | URL | -</span><br><span class="line"></span><br><span class="line">Build a new image from the source code at PATH</span><br><span class="line"></span><br><span class="line">-c, --cpu-shares=0                      CPU shares (relative weight)</span><br><span class="line"></span><br><span class="line">--cgroup-parent=                       Optional parent cgroup for the container</span><br><span class="line"></span><br><span class="line">--cpu-period=0                           Limit the CPU CFS (Completely Fair Scheduler) period</span><br><span class="line"></span><br><span class="line">--cpu-quota=0                            Limit the CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line"></span><br><span class="line">--cpuset-cpus=                           CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line"></span><br><span class="line">--cpuset-mems=                         MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line"></span><br><span class="line">--disable-content-trust=true       Skip image verification</span><br><span class="line"></span><br><span class="line">-f, --file=                                     Name of the Dockerfile (Default is 'PATH/Dockerfile')</span><br><span class="line"></span><br><span class="line">--force-rm=false                          Always remove intermediate containers</span><br><span class="line"></span><br><span class="line">--help=false                                 Print usage</span><br><span class="line"></span><br><span class="line">-m, --memory=                          Memory limit</span><br><span class="line"></span><br><span class="line">--memory-swap=                       Total memory (memory + swap), '-1' to disable swap</span><br><span class="line"></span><br><span class="line">--no-cache=false                        Do not use cache when building the image</span><br><span class="line"></span><br><span class="line">--pull=false                                 Always attempt to pull a newer version of the image</span><br><span class="line"></span><br><span class="line">-q, --quiet=false                         Suppress the verbose output generated by the containers</span><br><span class="line"></span><br><span class="line">--rm=true                                  Remove intermediate containers after a successful build</span><br><span class="line"></span><br><span class="line">-t, --tag=                                   Repository name (and optionally a tag) for the image</span><br><span class="line"></span><br><span class="line">--ulimit=[] Ulimit options</span><br></pre></td></tr></table></figure>


      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2017/07/09/docker/docker-commands-principle/">
      [Docker] Docker常用命令原理图
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jul 9, 2017</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1. 基本概念"></a>1. 基本概念</h1><h2 id="1-1-image-layer（镜像层）"><a href="#1-1-image-layer（镜像层）" class="headerlink" title="1.1. image layer（镜像层）"></a>1.1. image layer（镜像层）</h2><p>镜像可以看成是由多个镜像层叠加起来的一个文件系统，镜像层也可以简单理解为一个基本的镜像，而每个镜像层之间通过指针的形式进行叠加。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578327/article/docker/commands/1.png" alt="1"></p>
<p>根据上图，镜像层的主要组成部分包括镜像层id，镜像层指针【指向父层】，元数据【layer metadata】包含了docker构建和运行的信息还有父层的层次信息。</p>
<p>只读层和读写层【top layer】的组成部分基本一致。同时读写层可以转换成只读层【docker commit操作实现】</p>
<h2 id="1-2-image（镜像）—【只读层的集合】"><a href="#1-2-image（镜像）—【只读层的集合】" class="headerlink" title="1.2. image（镜像）—【只读层的集合】"></a>1.2. image（镜像）—【只读层的集合】</h2><p>1、镜像是一堆只读层的统一视角，除了最底层没有指向外，每一层都指向它的父层，统一文件系统（union file system）技术能够将不同的层整合成一个文件系统，为这些层提供了一个统一的视角，这样就隐藏了多层的存在，在用户的角度看来，只存在一个文件系统。而每一层都是不可写的，就是只读层。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578328/article/docker/commands/2.1.png" alt="2.1"></p>
<h2 id="1-3-container（容器）—【一层读写层-多层只读层】"><a href="#1-3-container（容器）—【一层读写层-多层只读层】" class="headerlink" title="1.3. container（容器）—【一层读写层+多层只读层】"></a>1.3. container（容器）—【一层读写层+多层只读层】</h2><p>1、容器和镜像的区别在于容器的最上面一层是读写层【top layer】，而这边并没有区分容器是否在运行。运行状态的容器【running container】即一个可读写的文件系统【静态容器】+隔离的进程空间和其中的进程。</p>
<p> <img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/3.1.png" alt="3.1"></p>
<p>隔离的进程空间中的进程可以对该读写层进行增删改，其运行状态容器的进程操作都作用在该读写层上。每个容器只能有一个进程隔离空间。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578328/article/docker/commands/3.2.png" alt="3.2"></p>
<h1 id="2-Docker常用命令原理图概览："><a href="#2-Docker常用命令原理图概览：" class="headerlink" title="2. Docker常用命令原理图概览："></a>2. Docker常用命令原理图概览：</h1><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510578333/article/docker/commands/dockerCommands.jpg" width="70%">

<h1 id="3-Docker常用命令说明"><a href="#3-Docker常用命令说明" class="headerlink" title="3.  Docker常用命令说明"></a>3.  Docker常用命令说明</h1><h2 id="3-1-标识说明"><a href="#3-1-标识说明" class="headerlink" title="3.1. 标识说明"></a>3.1. 标识说明</h2><h3 id="3-1-1-image—（统一只读文件系统）"><a href="#3-1-1-image—（统一只读文件系统）" class="headerlink" title="3.1.1. image—（统一只读文件系统）"></a>3.1.1. image—（统一只读文件系统）</h3><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.1.1.png" alt="4.1.1"></p>
<h3 id="3-1-2-静态容器【未运行的容器】—（统一可读写文件系统）"><a href="#3-1-2-静态容器【未运行的容器】—（统一可读写文件系统）" class="headerlink" title="3.1.2. 静态容器【未运行的容器】—（统一可读写文件系统）"></a>3.1.2. 静态容器【未运行的容器】—（统一可读写文件系统）</h3><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.1.2.png" alt="4.1.2"></p>
<h3 id="3-1-3-动态容器【running-container】—（进程空间（包括进程）-统一可读写文件系统）"><a href="#3-1-3-动态容器【running-container】—（进程空间（包括进程）-统一可读写文件系统）" class="headerlink" title="3.1.3. 动态容器【running container】—（进程空间（包括进程）+统一可读写文件系统）"></a>3.1.3. 动态容器【running container】—（进程空间（包括进程）+统一可读写文件系统）</h3><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.1.3.png" alt="4.1.3"></p>
<h2 id="3-2-命令说明"><a href="#3-2-命令说明" class="headerlink" title="3.2. 命令说明"></a>3.2. 命令说明</h2><h3 id="3-2-1-docker生命周期相关命令"><a href="#3-2-1-docker生命周期相关命令" class="headerlink" title="3.2.1. docker生命周期相关命令:"></a>3.2.1. docker生命周期相关命令:</h3><h4 id="3-2-1-1-docker-create-image-id"><a href="#3-2-1-1-docker-create-image-id" class="headerlink" title="3.2.1.1. docker create {image-id}"></a>3.2.1.1. docker create {image-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.1.png" alt="4.2.1.1"></p>
<p>即为只读文件系统添加一层可读写层【top layer】，生成可读写文件系统，该命令状态下容器为静态容器，并没有运行。</p>
<h4 id="3-2-1-2-docker-start（restart）-container-id"><a href="#3-2-1-2-docker-start（restart）-container-id" class="headerlink" title="3.2.1.2. docker start（restart） {container-id}"></a>3.2.1.2. docker start（restart） {container-id}</h4><p>docker stop即为docker start的逆过程</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.2.png" alt="4.2.1.2"></p>
<p>即为可读写文件系统添加一个进程空间【包括进程】，生成动态容器【running container】</p>
<h4 id="3-2-1-3-docker-run-image-id"><a href="#3-2-1-3-docker-run-image-id" class="headerlink" title="3.2.1.3. docker run {image-id}"></a>3.2.1.3. docker run {image-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.3.png" alt="4.2.1.3"></p>
<p>docker run=docker create+docker start</p>
<p>类似流程如下 ：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.2.1.3.1.png" alt="4.2.1.3.1"></p>
<h4 id="3-2-1-4-docker-stop-container-id"><a href="#3-2-1-4-docker-stop-container-id" class="headerlink" title="3.2.1.4. docker stop {container-id}"></a>3.2.1.4. docker stop {container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.4.png" alt="4.2.1.4"></p>
<p>向运行的容器中发一个SIGTERM的信号，然后停止所有的进程。即为docker start的逆过程。</p>
<h4 id="3-2-1-5-docker-kill-container-id"><a href="#3-2-1-5-docker-kill-container-id" class="headerlink" title="3.2.1.5. docker kill {container-id}"></a>3.2.1.5. docker kill {container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.5.png" alt="4.2.1.5"></p>
<p>docker kill向容器发送不友好的SIGKILL的信号，相当于快速强制关闭容器，与docker stop的区别在于docker stop是正常关闭，先发SIGTERM信号，清理进程，再发SIGKILL信号退出。</p>
<h4 id="3-2-1-6-docker-pause-container-id"><a href="#3-2-1-6-docker-pause-container-id" class="headerlink" title="3.2.1.6. docker pause {container-id}"></a>3.2.1.6. docker pause {container-id}</h4><p>docker unpause为逆过程—比较少使用</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.6.png" alt="4.2.1.6"></p>
<p>暂停容器中的所有进程，使用cgroup的freezer顺序暂停容器里的所有进程，docker unpause为逆过程即恢复所有进程。比较少使用。</p>
<h4 id="3-2-1-7-docker-commit-container-id"><a href="#3-2-1-7-docker-commit-container-id" class="headerlink" title="3.2.1.7. docker commit {container-id}"></a>3.2.1.7. docker commit {container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.7.png" alt="4.2.1.7"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.7.2.png" alt="4.2.1.7.2"></p>
<p>把容器的可读写层转化成只读层，即从容器状态【可读写文件系统】变为镜像状态【只读文件系统】，可理解为【固化】。</p>
<h4 id="3-2-1-8-docker-build"><a href="#3-2-1-8-docker-build" class="headerlink" title="3.2.1.8. docker build"></a>3.2.1.8. docker build</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.8.1.png" alt="4.2.1.8.1"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.8.2.png" alt="4.2.1.8.2"></p>
<p><strong>docker build=docker run【运行容器】+【进程修改数据】+docker commit【固化数据】，不断循环直至生成所需镜像。</strong></p>
<p>循环一次便会形成新的层（镜像）【原镜像层+已固化的可读写层】</p>
<p>docker build 一般作用在dockerfile文件上。</p>
<h3 id="3-2-2-docker查询类命令"><a href="#3-2-2-docker查询类命令" class="headerlink" title="3.2.2. docker查询类命令"></a>3.2.2. docker查询类命令</h3><p>查询对象：①image，②container，③image/container中的数据，④系统信息[容器数，镜像数及其他]</p>
<h4 id="3-2-2-1-Image"><a href="#3-2-2-1-Image" class="headerlink" title="3.2.2.1. Image"></a>3.2.2.1. Image</h4><h4 id="1、docker-images"><a href="#1、docker-images" class="headerlink" title="1、docker images"></a>1、docker images</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.1.1.png" alt="4.2.2.1.1"></p>
<p>docker images 列出当前镜像【以顶层镜像id来表示整个完整镜像】，每个顶层镜像下面隐藏多个镜像层。</p>
<h4 id="2、docker-images-a"><a href="#2、docker-images-a" class="headerlink" title="2、docker images -a"></a>2、docker images -a</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.1.2.png" alt="4.2.2.1.2"></p>
<p>docker images -a列出所有镜像层【排序以每个顶层镜像id为首后接该镜像下的所有镜像层】，依次列出每个镜像的所有镜像层。</p>
<h4 id="3、docker-history-image-id"><a href="#3、docker-history-image-id" class="headerlink" title="3、docker history {image-id}"></a>3、docker history {image-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.1.3.png" alt="4.2.2.1.3"></p>
<p>docker history 列出该镜像id下的所有历史镜像。</p>
<h4 id="3-2-2-2-Container"><a href="#3-2-2-2-Container" class="headerlink" title="3.2.2.2. Container"></a>3.2.2.2. Container</h4><h4 id="1、docker-ps"><a href="#1、docker-ps" class="headerlink" title="1、docker ps"></a>1、docker ps</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.2.1.png" alt="4.2.2.2.1"></p>
<p>列出所有运行的容器【running container】</p>
<h4 id="2、docker-ps-a"><a href="#2、docker-ps-a" class="headerlink" title="2、docker ps -a"></a>2、docker ps -a</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.2.2.png" alt="4.2.2.2.2"></p>
<p>列出所有容器，包括静态容器【未运行的容器】和动态容器【running container】</p>
<h4 id="3-2-2-3-Info"><a href="#3-2-2-3-Info" class="headerlink" title="3.2.2.3. Info"></a>3.2.2.3. Info</h4><h4 id="1、docker-inspect-container-id-or-image-id"><a href="#1、docker-inspect-container-id-or-image-id" class="headerlink" title="1、docker inspect {container-id} or {image-id}"></a>1、docker inspect {container-id} or {image-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.3.1.png" alt="4.2.2.3.1"></p>
<p>提取出容器或镜像最顶层的元数据。</p>
<h4 id="2、docker-info"><a href="#2、docker-info" class="headerlink" title="2、docker info"></a>2、docker info</h4><p>显示 Docker 系统信息，包括镜像和容器数。</p>
<h3 id="3-2-3-docker操作类命令："><a href="#3-2-3-docker操作类命令：" class="headerlink" title="3.2.3. docker操作类命令："></a>3.2.3. docker操作类命令：</h3><h4 id="3-2-3-1-docker-rm-container-id"><a href="#3-2-3-1-docker-rm-container-id" class="headerlink" title="3.2.3.1. docker rm {container-id}"></a>3.2.3.1. docker rm {container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.1.png" alt="4.2.3.1"></p>
<p>docker rm会移除镜像，该命令只能对静态容器【非运行状态】进行操作。</p>
<p>通过docker rm -f {container-id}的-f （force）参数可以强制删除运行状态的容器【running container】。</p>
<h4 id="3-2-3-2-docker-rmi-image-id"><a href="#3-2-3-2-docker-rmi-image-id" class="headerlink" title="3.2.3.2. docker rmi {image-id}"></a>3.2.3.2. docker rmi {image-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.2.png" alt="4.2.3.2"></p>
<h4 id="3-2-3-3-docker-exec-running-container-id"><a href="#3-2-3-3-docker-exec-running-container-id" class="headerlink" title="3.2.3.3. docker exec {running-container-id}"></a>3.2.3.3. docker exec {running-container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.3.png" alt="4.2.3.3"></p>
<p>docker exec会在运行状态的容器中执行一个新的进程。</p>
<h4 id="3-2-3-4-docker-export-container-id"><a href="#3-2-3-4-docker-export-container-id" class="headerlink" title="3.2.3.4. docker export {container-id}"></a>3.2.3.4. docker export {container-id}</h4><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578333/article/docker/commands/4.2.3.4.png" alt="4.2.3.4"></p>
<p>docker export命令创建一个tar文件，并且移除了元数据和不必要的层，将多个层整合成了一个层，只保存了当前统一视角看到的内容。</p>
<p>参考文章：</p>
<ul>
<li><a href="http://merrigrove.blogspot.com/2015/10/visualizing-docker-containers-and-images.html" target="_blank" rel="noopener">http://merrigrove.blogspot.com/2015/10/visualizing-docker-containers-and-images.html</a></li>
</ul>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2017/07/09/docker/docker-architecture/">
      [Docker] Docker整体架构图
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="https://new.zzpblog.cn" target="_blank" rel="nofollow noopener">
    <img src="https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png">
    <p>zz胖</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jul 9, 2017</p>
  </a>
</div>

            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、Docker的总架构图"><a href="#一、Docker的总架构图" class="headerlink" title="一、Docker的总架构图"></a>一、Docker的总架构图</h2><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577966/article/docker/dockerArch/docker-architecture.jpg" width="60%"/>

<p>docker是一个C/S模式的架构，后端是一个松耦合架构，模块各司其职。</p>
<ol>
<li>用户是使用Docker Client与Docker Daemon建立通信，并发送请求给后者。</li>
<li>Docker Daemon作为Docker架构中的主体部分，首先提供Server的功能使其可以接受Docker Client的请求；</li>
<li>Engine执行Docker内部的一系列工作，每一项工作都是以一个Job的形式的存在。</li>
<li>Job的运行过程中，当需要容器镜像时，则从Docker Registry中下载镜像，并通过镜像管理驱动graphdriver将下载镜像以Graph的形式存储；</li>
<li>当需要为Docker创建网络环境时，通过网络管理驱动networkdriver创建并配置Docker容器网络环境；</li>
<li>当需要限制Docker容器运行资源或执行用户指令等操作时，则通过execdriver来完成。</li>
<li>libcontainer是一项独立的容器管理包，networkdriver以及execdriver都是通过libcontainer来实现具体对容器进行的操作。</li>
</ol>
<h2 id="二、Docker各模块组件分析"><a href="#二、Docker各模块组件分析" class="headerlink" title="二、Docker各模块组件分析"></a>二、Docker各模块组件分析</h2><h3 id="（一）Docker-Client-发起请求"><a href="#（一）Docker-Client-发起请求" class="headerlink" title="（一）Docker Client[发起请求]"></a>（一）Docker Client[发起请求]</h3><ol>
<li>Docker Client是和Docker Daemon建立通信的客户端。用户使用的可执行文件为docker（类似可执行脚本的命令），docker命令后接参数的形式来实现一个完整的请求命令（例如docker images，docker为命令不可变，images为参数可变）。</li>
<li>Docker Client可以通过以下三种方式和Docker Daemon建立通信：<a href="">tcp://host:port，unix://path_to_socket和fd://socketfd。</a></li>
<li>Docker Client发送容器管理请求后，由Docker Daemon接受并处理请求，当Docker Client接收到返回的请求相应并简单处理后，Docker Client一次完整的生命周期就结束了。[一次完整的请求：发送请求→处理请求→返回结果]，与传统的C/S架构请求流程并无不同。</li>
</ol>
<h3 id="（二）Docker-Daemon-后台守护进程"><a href="#（二）Docker-Daemon-后台守护进程" class="headerlink" title="（二）Docker Daemon[后台守护进程]"></a>（二）Docker Daemon[后台守护进程]</h3><ul>
<li><p>Docker Daemon的架构图</p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/docker-daemon.jpg" width="60%"/>
</li>
</ul>
<ol>
<li><h4 id="Docker-Server-调度分发请求"><a href="#Docker-Server-调度分发请求" class="headerlink" title="Docker Server[调度分发请求]"></a>Docker Server[调度分发请求]</h4><ul>
<li>Docker Server的架构图</li>
</ul>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/docker-server.jpg" width="60%"/>

<ol>
<li>Docker Server相当于C/S架构的服务端。功能为接受并调度分发Docker Client发送的请求。接受请求后，Server通过路由与分发调度，找到相应的Handler来执行请求。</li>
<li>在Docker的启动过程中，通过包gorilla/mux，创建了一个mux.Router，提供请求的路由功能。在Golang中，gorilla/mux是一个强大的URL路由器以及调度分发器。该mux.Router中添加了众多的路由项，每一个路由项由HTTP请求方法（PUT、POST、GET或DELETE）、URL、Handler三部分组成。</li>
<li>创建完mux.Router之后，Docker将Server的监听地址以及mux.Router作为参数，创建一个httpSrv=http.Server{}，最终执行httpSrv.Serve()为请求服务。</li>
<li>在Server的服务过程中，Server在listener上接受Docker Client的访问请求，并创建一个全新的goroutine来服务该请求。在goroutine中，首先读取请求内容，然后做解析工作，接着找到相应的路由项，随后调用相应的Handler来处理该请求，最后Handler处理完请求之后回复该请求。</li>
</ol>
</li>
<li><h4 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h4><ol>
<li>Engine是Docker架构中的运行引擎，同时也Docker运行的核心模块。它扮演Docker container存储仓库的角色，并且通过执行job的方式来操纵管理这些容器。</li>
<li>在Engine数据结构的设计与实现过程中，有一个handler对象。该handler对象存储的都是关于众多特定job的handler处理访问。举例说明，Engine的handler对象中有一项为：{“create”: daemon.ContainerCreate,}，则说明当名为”create”的job在运行时，执行的是daemon.ContainerCreate的handler。</li>
</ol>
</li>
<li><h4 id="job"><a href="#job" class="headerlink" title="job"></a>job</h4><ol>
<li>一个Job可以认为是Docker架构中Engine内部最基本的工作执行单元。Docker可以做的每一项工作，都可以抽象为一个job。例如：在容器内部运行一个进程，这是一个job；创建一个新的容器，这是一个job。Docker Server的运行过程也是一个job，名为serveapi。</li>
<li>Job的设计者，把Job设计得与Unix进程相仿。比如说：Job有一个名称，有参数，有环境变量，有标准的输入输出，有错误处理，有返回状态等。</li>
</ol>
</li>
</ol>
<h3 id="（三）Docker-Registry-镜像注册中心"><a href="#（三）Docker-Registry-镜像注册中心" class="headerlink" title="（三）Docker Registry[镜像注册中心]"></a>（三）Docker Registry[镜像注册中心]</h3><ol>
<li>Docker Registry是一个存储容器镜像的仓库（注册中心），可理解为云端镜像仓库，按repository来分类，docker pull 按照[repository]:[tag]来精确定义一个image。</li>
<li>在Docker的运行过程中，Docker Daemon会与Docker Registry通信，并实现搜索镜像、下载镜像、上传镜像三个功能，这三个功能对应的job名称分别为”search”，”pull” 与 “push”。</li>
<li>可分为公有仓库（docker hub）和私有仓库。</li>
</ol>
<h3 id="（四）Graph-docker内部数据库"><a href="#（四）Graph-docker内部数据库" class="headerlink" title="（四）Graph[docker内部数据库]"></a>（四）Graph[docker内部数据库]</h3><ul>
<li><p>Graph的架构图</p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/graph-architecture.jpg" width="60%"/>
</li>
</ul>
<ol>
<li><h4 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h4><ol>
<li>已下载镜像的保管者（包括下载镜像和dockerfile构建的镜像）。</li>
<li>一个repository表示某类镜像的仓库（例如Ubuntu），同一个repository内的镜像用tag来区分（表示同一类镜像的不同标签或版本）。一个registry包含多个repository，一个repository包含同类型的多个image。</li>
<li>镜像的存储类型有aufs，devicemapper,Btrfs，Vfs等。其中centos系统使用devicemapper的存储类型。</li>
<li>同时在Graph的本地目录中，关于每一个的容器镜像，具体存储的信息有：该容器镜像的元数据，容器镜像的大小信息，以及该容器镜像所代表的具体rootfs。</li>
</ol>
</li>
<li><h4 id="GraphDB"><a href="#GraphDB" class="headerlink" title="GraphDB"></a>GraphDB</h4><ol>
<li>已下载容器镜像之间关系的记录者。</li>
<li>GraphDB是一个构建在SQLite之上的小型图数据库，实现了节点的命名以及节点之间关联关系的记录</li>
</ol>
</li>
</ol>
<h3 id="（五）Driver-执行部分"><a href="#（五）Driver-执行部分" class="headerlink" title="（五）Driver[执行部分]"></a>（五）Driver[执行部分]</h3><p>Driver是Docker架构中的驱动模块。通过Driver驱动，Docker可以实现对Docker容器执行环境的定制。即Graph负责镜像的存储，Driver负责容器的执行。</p>
<ol>
<li><h4 id="graphdriver"><a href="#graphdriver" class="headerlink" title="graphdriver"></a>graphdriver</h4><ul>
<li><p>graphdriver架构图</p>
 <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/graphdriver.jpg" width="60%"/>
</li>
</ul>
<ol>
<li>graphdriver主要用于完成容器镜像的管理，包括存储与获取。</li>
<li>存储：docker pull下载的镜像由graphdriver存储到本地的指定目录（Graph中）。</li>
<li>获取：docker run（create）用镜像来创建容器的时候由graphdriver到本地Graph中获取镜像。</li>
</ol>
</li>
</ol>
<ol>
<li><h4 id="networkdriver"><a href="#networkdriver" class="headerlink" title="networkdriver"></a>networkdriver</h4><ul>
<li><p>networkdriver的架构图</p>
 <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/networkdriver.jpg" width="60%"/>
</li>
</ul>
<ol>
<li>networkdriver的用途是完成Docker容器网络环境的配置，其中包括<ul>
<li>Docker启动时为Docker环境创建网桥；</li>
<li>Docker容器创建时为其创建专属虚拟网卡设备；</li>
<li>Docker容器分配IP、端口并与宿主机做端口映射，设置容器防火墙策略等。</li>
</ul>
</li>
</ol>
</li>
<li><h4 id="execdriver"><a href="#execdriver" class="headerlink" title="execdriver"></a>execdriver</h4><ul>
<li><p>execdriver的架构图</p>
 <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/execdriver.jpg" width="55%"/>
</li>
</ul>
<ol>
<li>execdriver作为Docker容器的执行驱动，负责创建容器运行命名空间，负责容器资源使用的统计与限制，负责容器内部进程的真正运行等。</li>
<li>现在execdriver默认使用native驱动，不依赖于LXC。</li>
</ol>
</li>
</ol>
<h3 id="（六）libcontainer-函数库"><a href="#（六）libcontainer-函数库" class="headerlink" title="（六）libcontainer[函数库]"></a>（六）libcontainer[函数库]</h3><ul>
<li><p>libcontainer的架构图</p>
 <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/libcontainer.jpg" width="60%"/>
</li>
</ul>
<ol>
<li>libcontainer是Docker架构中一个使用Go语言设计实现的库，设计初衷是希望该库可以不依靠任何依赖，直接访问内核中与容器相关的API。</li>
<li>Docker可以直接调用libcontainer，而最终操纵容器的namespace、cgroups、apparmor、网络设备以及防火墙规则等。</li>
<li>libcontainer提供了一整套标准的接口来满足上层对容器管理的需求。或者说，libcontainer屏蔽了Docker上层对容器的直接管理。</li>
</ol>
<h3 id="（七）docker-container-服务交付的最终形式"><a href="#（七）docker-container-服务交付的最终形式" class="headerlink" title="（七）docker container[服务交付的最终形式]"></a>（七）docker container[服务交付的最终形式]</h3><ul>
<li><p>container架构</p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577966/article/docker/dockerArch/container.jpg" width="60%"/>
</li>
</ul>
<ol>
<li><p>Docker container（Docker容器）是Docker架构中服务交付的最终体现形式。</p>
</li>
<li><p>Docker按照用户的需求与指令，订制相应的Docker容器：</p>
</li>
<li><ul>
<li>用户通过指定容器镜像，使得Docker容器可以自定义rootfs等文件系统；</li>
<li>用户通过指定计算资源的配额，使得Docker容器使用指定的计算资源；</li>
<li>用户通过配置网络及其安全策略，使得Docker容器拥有独立且安全的网络环境；</li>
<li>用户通过指定运行的命令，使得Docker容器执行指定的工作。</li>
</ul>
</li>
</ol>
<p>附：本文在《docker源码分析》基础上进行整理。</p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
      <br>
      <div class="prev-next">
        
          <a class="prev" rel="prev" href="/page/5/">
            <section class="post prev white-box shadow" >
              <i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;Previous&nbsp;
            </section>
          </a>
        
        <p class="current">
          6 / 6
        </p>
        
      </div>
    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


</div>
<aside class='l_side'>
  
  
    
    

<section class="widget blogger shadow desktop mobile">
  <div class='content'>
    
      
        <a class='avatar flat-box' href='/about/'>
          <img no-lazy src='https://zzpblog.oss-cn-beijing.aliyuncs.com/avatar.png'/>
        </a>
      
    
    
      <div class='text'>
        
        
        
          <p><span id="jinrishici-sentence">zz胖的博客</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="https://github.com/superzzp"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=63035382"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

  

  
    
    
  

  <section class="widget category shadow desktop">
    
  <header>
    
      <a href='/blog/categories/'><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i><span class='name'>文章分类</span></a>
    
  </header>


    <div class='content'>
      <ul class="entry navigation">
        
          <li><a class="flat-box"
            title="/categories/Springboot/" href="/categories/Springboot/"
            id="categoriesSpringboot"
            ><div class='name'>Springboot</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/mapstruct/" href="/categories/mapstruct/"
            id="categoriesmapstruct"
            ><div class='name'>mapstruct</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/vue/" href="/categories/vue/"
            id="categoriesvue"
            ><div class='name'>vue</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"
            id="categoriesE5BC80E58F91E5B7A5E585B7"
            ><div class='name'>开发工具</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/"
            id="categoriesE69C8DE58AA1E599A8"
            ><div class='name'>服务器</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/"
            id="categoriesE8999AE68B9FE58C96E68A80E69CAF"
            ><div class='name'>虚拟化技术</div><div class='badge'>(15)</div></a></li>
        
      </ul>
    </div>
  </section>


  

  
    
    
  

  <section class="widget tagcloud shadow desktop mobile">
    
  <header>
    
      <a href='/blog/tags/'><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class='name'>热门标签</span></a>
    
  </header>


    <div class='content'>
      <a href="/tags/Docker/" style="font-size: 24px; color: #555">Docker</a> <a href="/tags/Idea/" style="font-size: 16.5px; color: #888">Idea</a> <a href="/tags/Nginx/" style="font-size: 14px; color: #999">Nginx</a> <a href="/tags/Node/" style="font-size: 24px; color: #555">Node</a> <a href="/tags/Redis/" style="font-size: 19px; color: #777">Redis</a> <a href="/tags/Spring-boot/" style="font-size: 14px; color: #999">Spring boot</a> <a href="/tags/Springboot/" style="font-size: 14px; color: #999">Springboot</a> <a href="/tags/Ubuntu/" style="font-size: 21.5px; color: #666">Ubuntu</a> <a href="/tags/linux/" style="font-size: 14px; color: #999">linux</a> <a href="/tags/mapstruct%E6%8F%92%E4%BB%B6/" style="font-size: 14px; color: #999">mapstruct插件</a> <a href="/tags/vscode/" style="font-size: 16.5px; color: #888">vscode</a> <a href="/tags/vue%E7%BB%84%E4%BB%B6%E5%BA%93/" style="font-size: 14px; color: #999">vue组件库</a>
    </div>
  </section>


  

  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='true'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='tencent'
      type='playlist'
      id='738933413'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="https://github.com/superzzp"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="" target="_blank" class="codename">zz胖的博客</a>
        as theme, total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://new.zzpblog.cn" target="_blank" rel="noopener">Copyright © 2020-2025 Mr. Z</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script defer src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/xaoxuu/cdn-wallpaper/abstract/41F215B9-261F-48B4-80B5-4E86E165259E.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  













  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.6.5/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 标准 markdown 描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>




  <script>setLoadingBarProgress(100);</script>
</body>
</html>
